\documentclass[11pt,a4paper]{article}
\parskip=12pt % adds vertical space between paragraphs
\renewcommand{\baselinestretch}{1.5} 

\addtolength{\oddsidemargin}{-.275in}
	\addtolength{\evensidemargin}{-.275in}
	\addtolength{\textwidth}{0.75in}

	\addtolength{\topmargin}{-.275in}
	\addtolength{\textheight}{0.75in}

\usepackage[utf8]{inputenc}
\usepackage[comma,authoryear]{natbib}
\bibliographystyle{plainnat}

\usepackage{lineno}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
%\usepackage{subfigure}
\usepackage{caption}
\usepackage[colorinlistoftodos]{todonotes}   % notes showed

%\usepackage{verbatim}
%\usepackage{moreverb} % for verbatim ouput
\usepackage{sverb}
\usepackage{hyperref}

\usepackage{authblk}

% Count of words
\immediate\write18{texcount -inc -incbib -sum NeuralOscillatorPaper.tex > wordcount.tex}


%For Supp. Numbering
\newcommand{\beginsupplement}{%
        \setcounter{table}{0}
        \renewcommand{\thetable}{S\arabic{table}}%
        \setcounter{figure}{0}
        \renewcommand{\thefigure}{S\arabic{figure}}%
     }


\newcommand{\Cov}{\mathrm{Cov}}
\newcommand{\Dros }{\emph{Drosophila }}

%Use the \todoXX where XX is your initials 
\newcommand{\todoKL}[1]{\todo[author=KL,color=blue!40, size=\tiny,inline]{#1}}
\newcommand{\todoAW}[1]{\todo[author=AW,color=green, size=\tiny,inline]{#1}}
\newcommand{\todoBW}[1]{\todo[author=BW,color=orange, size=\tiny,inline]{#1}}
\newcommand{\todoML}[1]{\todo[author=ML,color=white, size=\tiny,inline]{#1}}


\renewcommand{\vec}[1]{\boldsymbol{#1}}

%%Code location: The calculations were produced from the mathematica file Calculations/HeadModel.mb
%The pertubations used the function measurePertubationEffects in that file.

\title{Continuous lateral oscillations as a core mechanism for taxis in \Dros larvae}
\author{Antoine Wystrach\textsuperscript{1,2†}}
\author{Konstantinos Lagogiannis\textsuperscript{1†*} }
\author{Barbara Webb \textsuperscript{1}}
\affil{\textsuperscript{1} School of Informatics, University of Edinburgh}
\affil{\textsuperscript{2} Centre de recherche sur la cognition animal. CNRS. Universite de Toulouse}
\affil{\textsuperscript{†} These authors contributed equally to the work.}
\affil{\textsuperscript{*} Corresponding author klagogia@inf.ed.ac.uk}


%ex title{Taxis in \Dros larvae can be modelled as simple sensory modulation of lateral oscillation.}

\begin{document}
%\subsubsection*{Counts of words} 
%TC:ignore 
\linenumbers

%\listoftodos
%TC:endignore 

\maketitle

%---TC:break _ABSTRACT_
\begin{abstract}
Taxis behaviour in \Dros larva is thought to consist of distinct control mechanisms triggering specific actions. Here we support a simpler hypothesis: that taxis results from direct sensory modulation of continuous lateral oscillations of the anterior body, sparing the need for ‘action selection’. Our analysis of larvae motion reveals a rhythmic, continuous lateral oscillation of the anterior body, encompassing all head-sweeps, small or large, without breaking the oscillatory rhythm. Further, we show that an agent-model that embeds this hypothesis reproduces a surprising number of taxis signatures observed in larvae.  Also, by coupling the sensory input to a neural oscillator in continuous time, we show that the mechanism is robust and biologically plausible. The mechanism provides a simple architecture for combining information across modalities, and explaining how learnt associations modulate taxis. We discuss the results in the light of larval neural circuitry and make testable predictions.
\end{abstract}

%---TC:break _MAIN_
\section{Introduction}
The larvae of \Dros display taxis behaviours by spontaneously crawling towards or away from the source of stimuli such as odours, or more generally, up or down stimulus gradients, including chemical, light and temperature gradients \citep{luo2010navigational,gomez2011active,gomez2012active,gomez2014multilevel,kane2013sensorimotor,klein2015sensory}. This behavioural tendency is flexible and can be altered by associative learning if the stimulus is presented together with a positive or negative reinforcer \citep{ache2005olfaction,scherer2003olfactory,gerber2004engram,diegelmann2013maggot,schleyer2015learning}. The development of both a rich genetic manipulation toolkit and sophisticated behavioural assays 
% \citep{gerber2009smelling,diegelmann2013maggot} 
% \todoBW{additional citations needed} 
% removed the two arbitrary citations as this seems better as just a general statement
have provided the basis for a recent explosion of studies targeting the biological underpinnings of larval taxis, as an ideal model system for investigating the neural basis of sensorimotor control and learning.

Larval chemotaxis in particular has been extensively studied. The main chemosensory organ is located on the head, and the small spatial separation of the bilateral olfactory receptors makes it unlikely that the animal can detect the instantaneous odour gradient. In fact, it has been shown that larvae can still chemotax with a single active receptor  \citep{fishilevich2005chemotaxis,gomez2010mechanisms,louis2008bilateral}. The key information used by the larva  appears to be the change in odour concentration experienced as it moves forward and/or casts its head sideways \citep{gomez2010mechanisms}. 
%\AW-----------woulddelete KL: tried to link it better here, think its still relevant to ground our selves well from the beginning around these transients that we keep refering to next/. True though Can be spared but the whole idea of transients is not as well founded then/and missing from our BG literature.
Olfactory sensory neurons are well suited to carry this information as they have been shown to give strong transient responses during changes in odour concentration \citep{de2013common,nagel2011biophysical,kim2011system,schulze2015dynamical} and the frequency and direction of turns (large body bends leading to a new trajectory direction) appears correlated to  decreases or increases in the perceived concentration \citep{hernandez2015reverse,schulze2015dynamical}. 
  Other sensory modalities could in principle use spatially separated sensors to detect instantaneous gradients across the body to direct steering, but recent studies reveal substantial similarity in the characteristics of larval taxis behaviour across different modalities \citep{gepner2015computations, bellmann2010optogenetically, lahiri2011two}. This suggests it may be possible to provide a more general account that elucidates the nature of the sensory-motor transformation during all forms of taxis, and how multiple stimuli combine. 

Several models have been designed to capture quantitatively the observed larval behaviour during approach to odour sources  \citep{davies2015model,hernandez2015reverse,schleyer2015learning,gepner2015computations}. These models typically assume the expression of taxis consists of multiple behavioural states with state transitions that are biased by sensory stimuli. In \cite{davies2015model}, a model closely based on the behavioural analyses in
 \citet{lahiri2011two,gomez2014multilevel,gomez2011active} reproduces many characteristics of larval chemotaxis by combining three mechanisms: biased forward runs (weathervaning), increased probability to stop runs when odour concentration decreases (klinokinesis), and increased probability to resume running when a head cast is in a direction that increases the experienced odour concentration (klinotaxis). Each contributes to improve odour taxis performance, and in theory each could be individually modulated by sensory stimuli characteristics, context, other stimuli, or learning, in manner that modifies the observed odour preferences. 
 % However, there is no clear behavioural evidence for independent modulation of different mechanisms under different circumstances.
%\todoBW{This statement makes me a bit nervous - are we sure there are no papers where e.g. run length changes while turning does not?} 
However, behavioural observation shows rather strong similarities in the behavioural modulations resulting from apparently unrelated conditions, such as odour-tastant associative learning and variation of stimulus concentration \citep{schleyer2015learning}, which simultaneously modulate both the klinokinetic and klinotactic response (weathervaning was not assessed in this study). Also, a recent attempt to categorise larval behavioural states using an unsupervised method based on the animal's posture suggests the existence of a continuum rather than clear cut categories \citep{szigeti2015searching}.


It remains possible that the apparent repertoire of taxis behaviours seen in the larvae is in fact the result of a single underlying mechanism. In this paper, we take a bottom up, synthetic approach \citep{braitenberg1986vehicles} to investigate whether a simpler sensorimotor control scheme can give rise to the observed phenomena of taxis. We combined a detailed observation of the larva's crawling motions with an agent-based simulation to explore the behaviours that can emerge from the interaction between brain, body and environment.

Specifically, inspired by the description in larvae of frequent low amplitude head sweeps that modulate run direction \citep{gomez2014multilevel} and the model for taxis in {\it C. elegans} proposed in \citet{izquierdo2010evolution}, we investigated the hypothesis that taxis in larvae results from continuous anterior body oscillations modulated by immediate sensory inputs. 
Our analysis reveals that larvae indeed display continuous anterior body oscillation. We show that, based on this principle, both a simple discrete time model and a neural model in continuous time can reproduce many specific larval taxis signatures, without requiring specific parameter tuning to different conditions. Finally, we discuss the biological relevance of our proposed mechanism and how it could provide a simple and robust solution for combining information across modalities, or from learnt and innate pathways, to modulate taxis. 

\section{Results}
\subsection{Evidence for continuous anterior body oscillation in larvae}
 We used previously recorded tracks of 42 wild type larvae performing innate chemotaxis \citep{gomez2012active} to analyse the body-bend, the anterior body angular velocity and the forward speed. This reveals a continuous alternation between left and right turns, which appears most clearly in the angular velocity of the anterior part of the body (Figure \ref{fig:DynamicsExample}A ‘blue line’). Larvae are known to regularly stop their forward peristalsis motion and display large lateral head sweeps \citep{gomez2011active}. A closer look shows that these head sweeps do not seem to break the continuous alternation between left and right turns, i.e., if the larva’s head was moving left before stopping the peristalsis motion, the first head sweep after stopping will be to the right, and vice versa (Figure \ref{fig:DynamicsExample}B) and Figure \ref{fig:GroupAnalysis}A,B). Thus these head sweeps appear to be part of a continuous oscillation rather than individual motor actions triggered independently. Also, the distribution of body bending, anterior body angular velocity and acceleration, as well as the extent of each lateral oscillation of the anterior body, show a smooth curve with no signs of bimodality (Figure \ref{fig:GroupAnalysis}D) suggesting a continuum of turning modulation rather than a discrete set of distinguishable actions. 

A Fourier analysis confirms the existence of an oscillatory rhythm with a mean frequency around 0.3Hz; that is roughly one turn left and one turn right every 3.3 seconds (Figure \ref{fig:GroupAnalysis}C, blue). This turning oscillation seems decoupled from the peristalsis motion (supplemental Figure \ref{fig:FigS1}), which operates around a mean frequency of 1.1 Hz (Figure \ref{fig:GroupAnalysis}C, green). The peristalsis rhythm appears remarkably constant,  probably because of biomechanical constraints \citep{ross2015model}). Therefore, a direct coupling between peristalsis and turning oscillation would constrain the larvae to spend as much time sweeping left as sweeping right, which would restrict the flexibility in trajectory alterations. By having the the lateral oscillations decoupled from peristalsis however, the relative duration between left and right sweeps can vary. This is indeed what we observed in larvae. A curving path to the left for instance, is achieved by spending more time (and also increasing the angular speed) sweeping left than sweeping right (Figure \ref{fig:DynamicsExample}A ‘blue region’:  Time spent turning right = 12.9s; Time spent turning left = 22.9s; Ratio right/left= 0.64. Integral left =179.3 degrees; Integral right = -64.6 degrees; Total = 114.7 degrees left; Ratio right/left= 0.73).

To summarize, our observations support the hypothesis that a continuous lateral oscillation of the anterior body sits at the core of the chemotaxis mechanism, and that its rhythm is decoupled to the peristaltic rhythm thus allowing more freedom to adjust the head-turning velocity and amplitude.


\subsection{Hypotheses and modelling assumptions}

We embedded the idea that continuous lateral oscillation of the anterior body sits at the core of the taxis mechanism in two simple agent-based models, discrete and continuous. Our hypotheses are:

\begin{itemize}

\item ‘Small amplitude head-casts’ and ‘large amplitude head-casts’ (Gomez Marin 2014) are manifestations of a single underlying mechanism that continuously drives a lateral oscillation of the anterior body (head casts). 

\item The {\it direction} (left or right) of a head-cast at a given time-step is determined only by the current state of an intrinsic oscillator rather than the sensory input or its history, or an active choice by the larva to probe the environment.

\item The {\it amplitude} of each of these alternating head-casts is continuously modulated by the stimulus perceived.

\end{itemize}

We sought to simplify our models as far as possible so as to establish the nature of the essential sensorimotor components that could underlie the emergence of chemotactic signatures observed in larvae. Our implemented models therefore also make the following assumptions:

\begin{itemize}

\item Stopping (inhibition of forward peristalsis) is not essential for taxis, except insofar as it aids reorientation by enabling larger turns or tighter curvature of paths. Hence we neglect stops, and in our model, the agent is continuously stepping forward, even when displaying large turns. Note that we address the limits of this assumption, and how stopping could be introduced to the model, in the discussion.

\item As the anterior body bearing determines the forward step direction in larvae, we assume it is the crucial variable for taxis, and not the actual bend of the body. Therefore, we limit our model to a single oriented point in space, representing the position of the larva as a whole along with its current bearing. The control mechanism then determines the trajectory of that point through space. 
This way of abstracting the larval trajectory has been used in previous biological analysis (\citep{louis2008bilateral}), and enables us to compare our model to larval trajectory statistics. 

\end{itemize}

\subsection{A simple oscillatory agent reproduces taxis}

We first embedded the above ideas into a discrete-time agent \ref{sec:methodsDiscreteAgent}). At each time step, the point agent rotates on the spot (by an amount $\alpha$, see Figure \ref{fig:MethodAgent}A, grey arrow) and makes a step forward of a fixed size $\lambda$ ($\lambda$=1mm) in this new direction (Figure \ref{fig:MethodAgent}A).

The {\it direction} of these re-orientations alternate between left and right at each time step (Figure \ref{fig:MethodAgent}A). This represents the continuous heading oscillation observed in larvae (Figure \ref{fig:DynamicsExample}).  

The {\it amplitude} ($\alpha$) of these left/right alternating re-orientations are constrained to by an upper and lower boundary \eqref{eq:boundary}. For most results reported in this paper the lower bound is 0 degrees (prevents a `right' turn becoming a `left' turn or vice versa) and the upper bound 180 degrees to represent the maximum possible re-orientation given the larva body bending constraints (Figure \ref{fig:MethodAgent}A,B dashed line).

In the absence of any stimulus, the {\it amplitude} ($\alpha$) of these re-orientations have a baseline angle $\theta_{B}$. In the main results, we set $\theta_{B}$ = 10 deg, so as to roughly match the apparent amplitude of the oscillations observed in larva in the absence of strong modulations \ref{fig:DynamicsExample}A. However, the value of this parameter is not crucial for the emergence of taxis (Figure \ref{fig:FigS3}).
%\todoBW{There may be a problem with the figure labels here (and other refs to supplementary figures?) as this shows up as S2 in the pdf, which is the wrong reference}

In the presence of stimulation, such as a gradient of odour concentration, the {\it amplitude} ($\alpha$) of these re-orientations are modulated by the stimulus perceived. The stimulus perceived is taken as the difference in stimulus intensity between the previous and current location (in our model: $\nabla s$) (Figure \ref{fig:MethodAgent}B). 
The {\it amplitude} ($\alpha$) of the rotation is determined by a simple linear function: $\nabla s$ is multiplied by a constant: the gain $g$, and this modulation is added to the baseline intrinsic oscillations $\theta_{B}$ (Figure \ref{fig:MethodAgent}B). Thus bearing angle can be bidirectionally modulated, that is, the signal perceived can lead to an increase or decrease in turning size, as compared to the baseline angle $\theta_{B}$, depending on the sign of $\nabla s$  and the gain $g$ (Figure \ref{fig:MethodAgent}B).

The value of the gain $g$, which is constant, thus represents the sensory-motor transformation, that is, how the sensory stimulation perceived is transformed into a motor command. What this linear transformation could imply for the larva is considered in the discussion. 

Figure \ref{fig:MethodAgent}C,D shows that this simple agent is sufficient for taxis to emerge. The behaviour is very robust to choice of baseline turning angle or gain values (supplementary Figure \ref{fig:FigS3}). Effectively, a negative gain ($g<0$) yields attraction towards higher stimulus intensity because decreasing stimulation ($\nabla s<0$) triggers strong re-orientations, while increasing stimulation ($\nabla s>0$) straightens the path (Figure\ref{fig:MethodAgent}B). Inversely, a positive gain ($g>0$) yields aversion (D), and a null gain ($g=0$) yields neither attraction nor repulsion. While the sign of the gain $g$ determines attraction or repulsion, its size determine the strength of it: the larger the gain, the stronger the agent's reaction to the sensory stimulation is, and thus stronger attraction or aversion emerges in the resulting trajectories (see figure \ref{fig:FigS3}, first row).

In the following sections, we examine how well this basic model can capture the typical chemotactic signatures observed in larvae, including path shapes, bearing to odour distribution shapes, sensory history, and their qualitative change resulting from typical manipulations such as change in stimulus concentration, associative learning or presence of tastants. 

\subsection{Characteristic taxis trajectories}
 %: orbital and segmented search
An emergent property of our agent model is that, for attractive odour (i.e. a negative gain), the distribution of bearing angle to the odour's source shows two peaks around 90 and -90 degrees (Figure \ref{fig:PathSignatures}). Therefore, the agent tends to spend more time with the odour on its sides rather than directly in front or behind it. Interestingly, this seems to be also the case with real larvae (Figure \ref{fig:PathSignatures}).
%% \todoML{Line 182: note that the fact that large turns tend to happen when the odor at in the larva’s back is compatible with the results shown in Fig 3D of our Nat Com 2011. }
 For both larval and the agent generated paths, this tendency is emphasised while displaying no large turns (Figure \ref{fig:PathSignatures}C blue line) and large turns tend to happen while the odour is located behind (Figure \ref{fig:PathSignatures}C red line), a result consistent with previous findings \cite{gomez2011active,schleyer2015impact}.
 Spending time with the odour located 90 degrees on the side translates into orbiting around the odour source. This ‘orbital behaviour’ can be observed clearly in simulations results from the deterministic (absence of random noise) version of our agent model (Figures \ref{fig:PathSignatures}B and \ref{fig:OSN}B).

%%%%%\todoKL: Removed explanation, if we don't aim to analyse the agent/algorithm in this paper then we shouldn't need to explain why orbits arise in the results section.
%%%%%%The orbital behaviour in our model can be directly understood by noting the equivalence of our agent's algorithm to a line-search algorithm that is attempting to track the orientation of a peak (e.g., the point of maximum concentration) by successive left and right reorientations (see Figure \ref{fig:AlgoAnalysis}, supplementary material 1). In the absence of forward movement, re-orientation in the direction of the peak would converge incrementally until left and right positions fall on either side of the peak. However, as the agent is not stationary, every step taken that is not headed exactly towards the peak will cause the direction of the peak, relative to the agent, to shift. The speed of this apparent peak shift, for a fixed step size, increases as the agent gets closer to the source. Orbits thus arises when the speed of the shifting peak matches the agent's reorientation speed. Reorientation speed depends on the agent's sensory transient to turn modulation gain, so that the higher the gain, the closer to the source the orbit will be. If the reorientation speed is sufficient to exceed the apparent peak shift across all possible larval bearings to odour angles, then the agent's trajectory shape changes and is characterized by straight crossings over the odour source, and sharp re-orientation events once the peak has been passed over (Figure \ref{fig:PathSignatures}B). Examination of actual larvae paths suggests that larvae possess a transient-to-turn modulation gain high enough for such crossing-over trajectories to emerge when close to the odour source (Figure \ref{fig:PathSignatures}A, D); except for the Or42a single receptor mutant larvae, which show an orbital behaviour (see below). As a result the model predicts different statistics depending on the proximity to the odour: when crossing-over paths occur, this results in a flattening of the bearing-to-odour distribution curve; which we indeed observe also in real larvae (Figure \ref{fig:PathSignatures}D).
%%%%

However, increasing the gain (towards higher negative values) results in a qualitative change to the shape  of agent's trajectories from circular orbits to those characterized by straight crossings over the odour source, and sharp re-orientation events once the peak has been passed over, that is, when the odour sources is now located behind the agent (Figure \ref{fig:PathSignatures}B). When further away from the odour source, the change in concentration ($\nabla s$) perceived are smaller so, as during orbital behaviour, the agent tends to spent time with the odour on its side. As a result the model predicts different statistics depending on the proximity to the odour: when close to the odour, crossing-over paths occur, resulting in a flattening of the bearing-to-odour distribution curve. Examination of actual larvae paths suggests that larvae possess a $\nabla s$-to-turn modulation gain high enough for such crossing-over trajectories to emerge when close to the odour source (except for the Or42a single receptor mutant larvae, which shows an orbital behaviour (see below)), which indeed results in a flattening of the distribution curve (Figure \ref{fig:PathSignatures}A, D).  



\subsection{Or42A mutant behavioural signatures as simple change in gain}
In \cite{gomez2011active}, larvae with genetically modified peripheral olfactory circuits were shown to display different chemotactic signatures to wild-type larvae.
 Larvae that had the Or42a olfactory receptor ectopically expressed in the 21 intact ORNs appeared to conduct a rather less concentrated search near the odour source; larvae with only a single-functional pair of ORN active displayed an orbital behaviour, while anosmic larvae displayed what can be described as a random-search path (Figure \ref{fig:OSN}A).
 These different chemotactic signatures can be reproduced by our model by simply lowering (towards zero) the gain 
%\todo{In the next section we make a point of saying concentration changes the input signal, and learning the gain, with equivalent effects because of the linearity. Should we not introduce that point explicitly here?}
 (Figure \ref{fig:OSN}B).
 Due to the assumption that the mapping of the stimulus to the next turn angle is linear, the operations of scaling the change in concentration perceived ($\nabla s$) or modifying the $\nabla s$-to-turn gain are equivalent. Physiologically, we can expect that reducing the number of receptors would reduce the signal perceived. Thus, we can expect that the presence of only a single-functional pair of Or42a is equivalent to a low gain, hence the emergence of the orbital behaviour (Figure \ref{fig:OSN}).
 The signal perceived may be reduced even when the same Or42a is expressed ectopically in the 21 intact ORNs, as such a modified overall receptor ensemble may be less effective than the variety of ORs expressed in the wild-type because the olfactory system in the case is not as responsive over the whole concentration range of a gradient. Indeed, there is evidence from behavioural and physiological responses to suggest that at least two receptors with different concentration thresholds can be found to be sensitive to a particular odourant \citep{kreher2008translation}. 

Overall the model is consistent with the finding that ``the summed response of the entire receptor repertoire correlates with the strength of the behavioural response.” \citep{kreher2008translation}. Increasing the number of available receptors results in an overall increase in the input, which in our model is equivalent to increasing the gain.

%%KLDone\todoML{Line 228: bilateral sampling shouldn’t affect gain within AL. Do you imply the “gain" would be determined upstream from the antennal lobe? }
We believe that an increase in the gain could also underlies the improvement in chemotaxis seen between larva with bilateral olfactory input against larva that have a single olfactory sensory neuron expressed unilaterally  \citep{louis2008bilateral}. 
%KLDone\todoMl{Line 229: single functional don’t express a single receptor: this genotype expresses Orco in only one OSN.}
  Also, larva with a single functional ORN, which shows high-affinity to the tested odour, have been observed to perform large curved paths around a source. This behaviour has been previously described as a switch from attraction to aversion as mutant larvae approach the odour source \citep{gomez2011active, kreher2008translation}. %%Also check khurana2013olfactory
%%There is evidence from behavioural and physiological responses to support that at least two receptors with different concentration thresholds can be found to be sensitive to a particular odourant \citep{kreher2008translation}. Interestingly the behavioural responses in mutants missing the high-concentration tuned OR appear to turn into repulsion \citep{kreher2008translation,gomez2011active} 
  Reproducing this behaviour in our agent would simply requires us to assume the mutant's operational ORNs saturate close to the odour source. ORNs operating close to saturation will generally give weaker sensory transient responses that translate into a gain reduction, which we show produces orbiting paths. This would appear as though the agent has an aversion to higher concentrations if the orbit radius is large.
 
 


\subsection{Similar effects of odour concentration and learning}
The effect of changing the concentration of an odour source on the group statistics of innate larval chemotaxis has been reported in \citep{schleyer2015learning}. Specifically, they recorded turn rate and turn direction given the current bearing to odour (their Figures 3 and 4, redrawn in Figure \ref{fig:Concentration}A,C). For an attractive odour (n-amyl-acetate) turns occur more frequently when facing away from the odour and less frequently when facing towards it; and turning direction is more frequent to the side that the odour is on (originally shown in \citet{gomez2011active}). These phenomena were modulated by changing the concentration of the odour, with the effect of bearing angle on both turn rate and turn direction becoming more pronounced, and the approach to odour consequently more rapid, with increasing concentration. 

The same study \citep{schleyer2015learning} revealed that associative learning leads to the same modulation of chemotactic statistics as seen for concentration changes \citep[][Figures 3 and 4]{schleyer2015learning}. After appetitive learning (by pairing presentation of an odour with fructose reward) turns occur more often when facing away from the odour and less often when heading toward the odour; and turning direction is biased more strongly toward the odour source. The opposite is true for the ‘unpaired’ group for which the odour was presented when the reward was removed. 


 To compare these statistics to our simulation we approximated their definition of ‘turns’ (i.e., resuming motion on a significantly altered trajectory after stopping and casting) by selecting large orientation changes ($>30$ degrees) that are not followed immediately by another large change. The relevant bearing angle for a turn is taken to be the heading direction relative to the odour source on the previous time-step (before the large orientation change). We find the same pattern of turn rate and turn direction relative to bearing-to-odour (Figure \ref{fig:Concentration}B,D).

The effect of changing concentration can be modelled simply by assuming that higher concentration leads to a stronger stimulus perceived. This may result from steeper gradient of concentration, or, as for the Or42a results above, by assuming that higher concentrations yield stronger signals.  “Several studies have found that higher odour concentrations activate more neurons than lower concentrations, [...] at higher concentrations, many odorants activate multiple receptors, while at lower concentrations, many odorants activate fewer receptors” \citep{hallem2006coding}.
 As a result, changing the concentration modulates the turn rate and turn direction distributions in a similar fashion as for real larvae (Figure \ref{fig:Concentration})

Similarly, the effects of learning can be captured by our model given the assumption that appetitive learning increases the gain $g$, 
and unpaired learning decreases $g$ towards zero. Potentially, the change in gain could cross zero and change sign, therefore switching the behaviour from attraction to aversion (Figure \ref{fig:MethodAgent}). 
Indeed, the gain $g$ can be viewed as the net sum of the signals resulting from multiple olfactory inputs and pathways, some of which mediate aversion and other attraction. Therefore, a shift in the balance between the excitatory versus the inhibitory signals could eventually lead to a sign change in gain, thus explaining the continuum from attraction to aversion observed at the behavioural level (Figure \ref{fig:Concentration}). 

Note that the equivalence in behavioural changes observed for concentration and learning in larvae (Figure \ref{fig:Concentration}) is thus explained as a simple consequence of the linearity of the sensorimotor modulation in our model. A $\nabla s$ signal twice as strong (due to a more concentrated odour source) has the same effect on turning as a gain $g$ that is twice as strong (due to appetitive learning), hence producing similar outcomes. We thus predict that the motor effects of learning and odour concentration can sum up, leading to increased attraction (e.g., \ref{fig:Concentration} darkest red curve in concentration) insofar as the odour is still recognised by the larvae. It should be noted however that increasing the odour concentration is likely to alter the overall shape of the distribution of odour concentration, and thus could yield different trajectory shapes than learning.


%If learning is indeed reified as a simple change in gain, this could be either under a multiplicative scaling of innate gain, or an additive signal by which the learning pathway contributes to the innate gain. In our model we take learning to express an additive change in gain that could be either inhibitory or excitatory with the potential of changing attraction to aversion.
%KL:Not sure on this argument - it is not even justified by anything or reference, better remove: A modulatory effect could only reduce the gain to zero, not change its sign.
%Removed, looks like something for a discussion section - and cutting helps shorten the paper.  On the other hand, if the behaviour depends on a balance between innate attraction and aversion (contributing negative and postive gain respectively) then modulation of one contribution could result in the expression of the other. We discuss this in relation to possible neural pathways in the discussion.

\subsection{Learning and preference index}
Learning effects in larvae are more commonly assessed by calculating a preference index (PI) resulting from mass assays \citep{gerber2009smelling}. The PI is calculated by allowing up to 30 larvae to chemotax for a few minutes, and counting how many larvae end up on each side of a dish containing the odour that has been paired (or unpaired) with reward on one side. If we run the same mass assays on our simulation, it is clear that the hypothesised effect of learning on the gain results in modulating the efficacy of taxis, leading to group level preference indexes similar to those observed with real larvae (Figure \ref{fig:PreferenceIndex}A). Note that the PI ($(N_{odour-side}-N_{other-side})/N_{total}$)
varies quite linearly with the gain, roughly doubling when the gain doubles (Figure \ref{fig:PreferenceIndex}A).
 This relationship is robust to additive noise (Figure \ref{fig:PreferenceIndex}C), which was modelled by drawing from a normal distribution, transforming this to an angle, and adding it to the intended turning angle on each time-step.
  Even for very high noise levels, a clear performance index change in relation to changing gain is observed. These results together suggest that while it might be difficult to observe the effects of learning in individual larval actions (as they may be swamped by noise), it may nevertheless be possible to find the neural correlate of the substantial change in gain needed to produce a significant change in PI.
Note that this contrasts with results from a previous `state transition' model of chemotaxis \citep{davies2015model} where very small changes in the biases in state transitions had a strong non-linear impact on the PI, making it hard to reconcile the available data from individual tracking and mass assays.

\subsection{Effect of the presence of fructose}
\cite{schleyer2015learning} describe a particular effect of the presence of fructose during chemotaxis: it increases the overall turn rate, independently of the current bearing to the odour. (Figure \ref{fig:Tonic}A). To capture this effect, our model simply requires that fructose receptors provide a tonic input to the oscillator, i.e., modulating the size of the next head cast relative to the current stimulus intensity, rather than the phasic input (modulation proportional to change in stimulus intensity) we have assumed thus far. In this experimental situation, the fructose concentration is constant across the dish, so the effect is a constant increase that does not vary with the bearing to odour. For our model (see methods) such a tonic signal is equivalent to changing the baseline input $s_{\text{tonic}}$, hence the baseline size of turn, $\theta_B$, and thus the probability to display large turns. 

When released in a petri-dish with one half filled with pure agarose and the other half filled with agarose and fructose, more larvae are observed on the fructose side after a couple of minutes \citep{schleyer2011behavior}. A tonic effect of fructose could, in theory, mediate this gustatory preference, as increasing the overall turn rate might be expected to increase the time spent in the area of fructose, as a result of klinokinesis.
% \todoBW{missing citation}
 However, if we use the small tonic increase in turn rate that was observed in larvae, and test the behaviour of our agent under the same conditions, the effect is too weak and no significant gustatory index emerges within the 3 min of test (Figure \ref{fig:Tonic}B).

 To reproduce a significant tendency to stay on the fructose side without increasing the tonic effect of fructose beyond what is observed in \cite{schleyer2015learning}, we needed to introduce a phasic response to fructose, with a negative gain, which would lead the agent to react immediately to the sharp transition at the boundary; turning back when leaving the fructose area, or continuing straight when entering the area (Figure \ref{fig:Tonic}C,D). The simultaneous presence of a tonic effect helps, but is not crucial to observe a significant gustatory index (Figure \ref{fig:Tonic}B).

  Conversely, avoidance of repulsive tastants such as quinine or high concentrations of salt \citep{schleyer2011behavior} can be modelled using a phasic connection with positive gain (Figure \ref{fig:Tonic}B). We note here that many sensory neurons responses show both phasic and tonic components, and will return to this point in the discussion.

\subsection{Sensory history preceding turns}
The average sensory history perceived before the occurrence of large turns shows a slow monotonic decrease in concentration which extends up to 10s prior to the large turn. This has been reported for larvae during chemotaxis \citep{gomez2011active} or as a response to white noise optogenetic stimulation of olfactory receptor \citep{gepner2015computations}, and can also be observed in our model (Figure \ref{fig:SensoryHistory}).
 %%\todoML{Fig 8C: it would be interesting to know if you retrieve the experimentallyobserved turn-triggered average sensory history for Or42a-functional larvae (Nat Com 2011, Fig 5F). The sensory average is very different for Or42a-functional compared to wild type: instead of decreasing over time, it is flat. Related to this point, the simulated turn-triggered average sensory history that you report on Fig 8C for turn to low and high doesn’t seem to match with our experimental observations (Nat Com 2011, Fig 4C). }
  In larvae, this may suggest the existence of a low-pass filter enabling larvae to integrate monotonic decreases over relatively long time scales to increase the probability of triggering a large turn \citep{gomez2011active,davies2015model,gepner2015computations}. However, our model does not possess such a low-pass filter: large turns occur as the consequence of the stimulus change perceived during the last step only.

 In our model, the reason for this monotonic decrease over a much longer time scale is that a high turn is more likely to be triggered when the larvae is facing away from the odour at $t=0$ (hence experiences a strongly negative $\nabla s$); and facing away from the odour a $t=0$ means a high likelihood of facing away from the odour (or at least not towards it) at $t=-1$; and thus also, but slightly less likely, at $t=-2$; etc.
%%\todoML{Line 357: I agree that your correlative argument doesn’t seem to hold for the white noise analysis — couldn’t you simulate response to white noise?  }
  Further explanation is required however to explain how the monotonic decrease can result from white noise optogenetic stimulation \cite{gepner2015computations}. Our agent is a point in space, and therefore does not capture the details of large head sweep movements through space. Further investigation of dynamics at this level would require to implement our agent into a model of the larva body, which promise to be an interesting endeavour. Nonetheless, the emergence of this monotonic decrease from the interaction between our reactive agent and the environment suggests caution is needed when interpreting the causal implications of sensory history prior to actions.

\subsection{First-turn bias}
Larvae show a slight tendency to bias their first head cast (after a stop event) towards the side of the attractive stimulus (i.e. the odour side \citep{gomez2011active,gomez2012active} or darker side during negative phototaxis \citep{kane2013sensorimotor}, or towards preferred temperatures \citep{luo2010navigational}. This may suggest the involvement of bilateral sensing to obtain gradient information, or a memory of gradient information obtained during the run. But if we identify ‘turns’ in our model as those re-orientation angles exceeding the threshold that is usually associated with stopping in the larva, the agent also reveals a tendency to bias its first `turns' towards the odour source (Figure \ref{fig:FirstTurn}), despite having no gradient information other than the change from one time step to the next. This tendency arises because of the oscillatory nature of the agent. Given an attractive odour (i.e. a negative gain $g<0$) large re-orientation are more likely to be triggered when a negative $\nabla s$ has been perceived during the previous step. And since a negative $\nabla s$ is more likely to be perceived when turning away from the odour, the subsequent turn, in the opposite direction, is thus more likely to be directed towards the odour side. 

Nonetheless this bias is weak and requires a large data set to appear significant. Our model predicts that the bias should increases together with increasing odour attraction, whether from stronger gain due to appetitive learning; stronger sensory input due to increased odour concentration, or both (Figure \ref{fig:FirstTurn}A), and becomes more apparent when the odour is located on one side of the larvae (Figure \ref{fig:FirstTurn}B).

\subsection{A neural implementation of oscillation}
So far, we have used a simple discrete time model to examine whether the basic principle of continuous lateral oscillations, modulated in amplitude by the stimuli perceived, can account for larval taxis.
 A crucial consequence of this model is that the descending signal that controls directed behaviour in the animal does not need to be lateralised, e.g, there does not need to be a stronger signal to the side of the body closer to the stimulus source. Rather, directional bias emerges because the change in concentration perceived at one turning step determines the extent of the next turn.
  In our discrete-time model this effect is precise, which might imply that the descending signal in the larvae requires equal precision in the timing with which it interacts with the ongoing motor control of the oscillation.
% The descending signal amounts to the sensory signal $\nabla s$, which in the discrete-time model is given by the difference in concentration perceived between two successive time steps. 

Here, we aim investigate whether our hypothesis can be verified in continuous time given the biophysical constraint of having a neural implementation.
The agent is again abstracted to an oriented point-sensor but now, critically, the change in heading is driven by a model of coupled neural oscillators, while sensory stimuli are continuously updated under the agent's motion through the environment.
% Thus, the equivalent sensory signal in the continuous-time model is taken to be the derivative of the concentration perceived $\frac{dS}{dt}$.  % (see supplementary material to see how $\nabla s$ relates to $\frac{dS}{dt}$).  



 The neural oscillator is derived from the well established principle that neural systems operating as central pattern generators (CPGs) are the main drivers of rhythmic motor sequences underlying key behaviours such as locomotion, circulation, respiration and feeding \citep{delcomyn1980neural}.
In fact, a CPG is believed to operate  within the thoracic and abdominal segments of larvae, executing a motor program for exploratory locomotion \citep{hughes2007sensory,berni2012autonomous,lemon2015whole}, although the details of the underlying circuitry are unknown.
For our purposes we adapted (see Methods \ref{sec:methodsCoupledOscillator}) a spike-rate neural model of a CPG that has been successfully used to model lamprey locomotion \citep{cohen1992modelling,lansner1997realistic}, \cite[see][]{marder1996principles}.

The CPG consists of a pair of compartments, here taken to driving changes in heading of the agent (Figure \ref{fig:LampreyModel}A). 
Each compartment has a pool of self-connected excitatory neurons ($E$), and a cross-inhibitory interneuron ($C$) projecting to the other compartment.
  This produces a regular alternation in firing bursts between left and right sides that can be modified by the additional bilateral inputs, $A$ and $S$. The $A$ unit represent descending sensory signals either processed or direct, while the $S$ unit represents a modulatory signal.
 The spike rate in the two compartments drive the changes in heading angle via a simple mechanical model (\ref{fig:LampreyModel}.B, see Methods).
  This agent also ignores stops just like the discrete-time model.
   It moves forward at a constant speed in the direction pointed by the heading angle. In the absence of stimuli arriving from the input unit $A$, this system produces a regular $\pm 10$ degrees oscillation in the heading at around 0.3Hz.
    However, the sensory input allows this oscillation to be perturbed, modifying  the amplitude and phase relationships between the bursts of each side, resulting in a change in the agent heading in continuous time.

%\todo{AW.can be reshaped so as to avoid repeating the figure legend and what we did; just the results?}

We evaluated the effect of stimulus timing against oscillator phase  on the ability of this model to express overall bearing changes by delivering perturbations to the input $A$ (note both sides $L$ and $R$ receive the same perturbation) at different points in the oscillation cycle.
 Measuring the overall change in bearing against a bilateral step input of magnitude $A_m$ across different times $t_s$ showed that the larva can be steered in a direction determined by the sign of $A_m$ and the state of the oscillator at time $t_s$.
  The resulting steering varied smoothly with variation in the timing against the oscillator phase and therefore the change in bearing is not critically dependent on the timing of the perturbation (see Figure \ref{fig:LampreyModel}F). 
%\todoBW{I think you need to say how - by the sign of $A_m$?}

% An example of the oscillator activity and the stimulus used is shown at the bottom inset of \ref{fig:LampreyModel}.F (note for clarity the effect of the stimulus on the burst pattern is not shown), and the resulting angular velocity and bearing of the head shown in the central graph. \ref{fig:LampreyModel}.F (top) shows the effect on the bearing of the larva under step perturbations to the input $A$ as the timing of the onset $t_s$ of the perturbations is varied across the phase (see Methods). The change in bearing appears as a sinusoid against the timing of the onset of either a positive or negative step. \todo{need to explain better what this means}. The magnitude of the sinusoid is modulated by the size of the step $A_m$. Changing the sign of $A_m$ changes the direction of turning. 

We then examined the ability of the model to chemotax in a virtual odour environment. We show that the continuous agent also produces curved paths when further away from the odour source, characteristic of larval weathervaning behaviour, that subsequently become orbits around the odour source (Figure \ref{fig:LampreyModel}D). The parameters of the model have been set such that the frequency of oscillation is within the ranges observed in larva (see \ref{fig:LampreyModel}C), and thus when measuring the mean frequency of the heading oscillation over such trajectories we obtain a noisy frequency spectrum comparable to the larval trajectory data. 
Further we established that a doubling of the gain (from $g=70$ to $g=140$), which effectively doubles the input due to the sensory induced perturbations from the input $A$, results in a qualitatively comparable change to crossing-over trajectories, as observed with the discrete-time agent (Figure \ref{fig:PathSignatures}).
 The heading velocity dynamics emerging from the model (Figure \ref{fig:LampreyModel}.E) are reminiscent of the experimental data of anterior body angular velocity (Figure \ref{fig:DynamicsExample}) in terms that in both there is a baseline rhythm while heading velocity increases under larger re-orientations (see Figure \ref{fig:DynamicsExample}).
%% \todoML{Line 444: does this lead to the prediction that Or42a (low gain) would head cast less fast than WT? Same for Orco null?}%KL:Large Head cast relate to high speed in all cases / Added clarification of what the dynamics 

 
The sensory stimuli during a change in heading naturally fall into a fixed phase relationship to the oscillator activity since the turning direction is directly driven by which oscillator compartment is active. Therefore, the input perturbation perceived in the virtual odour environment relates to the turning motion as these two variables are in a closed-loop. 
Consequently, increasing the gain also increases heading angular velocity and thus results in sharper re-orientation manoeuvres, which in turn results in larger sensory perturbations.
 
%KLRemoved \todoBW{Is following paragraph necessary?}
%This agent model therefore demonstrated that continuous sensory signals can  directly modulated a pre-motor circuit activity. It is plausible that a CPG circuit resides in the segments of the larval VNC \citep{kohsaka2012development}, with modulatory neurons being an integral part in generating locomotive patterns \citep{suster2003targeted}. When coupled to drive a simple biomechanical model of the larval body, the directed motor behaviour produced resembled the one displayed during larval chemotaxis. 


\section{Discussion}
A close look at \Dros larvae crawling during chemotaxis assays reveals a continuous lateral oscillation of the anterior body. This encompasses the whole smooth range of amplitude of head sweeps, which alternate between left and right without breaking the oscillatory rhythm (Figures \ref{fig:DynamicsExample} and \ref{fig:GroupAnalysis}). 
This led us to the hypothesis that larval taxis behaviour results from direct ongoing sensory modulation of intrinsic, continuous lateral oscillations. We used two agent based simulations to investigate the behavioural signatures emerging from this hypothesis given the closed-loop interaction of brain, body and environment.
 
The models were simplified as far as possible so as to establish the nature of the essential sensorimotor components that could underlie the emergence of chemotactic signatures observed in larvae.
The larva is abstracted to a single point sensor associated with a heading. This point sensor is responsive to changes in stimulus intensity $\nabla s$, which modulates the amplitude of an ongoing left-right oscillation of its heading. Sensory signal and motor modulation are coupled by a simple linear gain $g$ and operate in a closed-loop with the environment (Figures \ref{fig:MethodAgent}, \ref{fig:LampreyModel}). 
These models produce robust taxis (Figures \ref{fig:MethodAgent}, \ref{fig:FigS3}, \ref{fig:LampreyModel}) and, despite their simplicity, capture a range of phenomena observed in larvae (see results) through simple variation of the gain.
% BW: see my earlier comment for why I think the next sentence belongs in the introduction.
%KL:It was moved here from Intro  hmm lets leave it here for now 
%BW: okay, I've put a mention in the intro for C.elegans.
%We therefore suggest that larval taxis results from a closed-loop sensory modulation of the dynamics of an intrinsic motor pattern, which can be a particularly efficient neural mechanism for flexible behavioural control \citep{lemon2015whole,izquierdo2010evolution,kanzaki1996behavioral,levi2005role,willis1997active}. 

 We here discuss the key conceptual elements of the models, their potential relationship to the underlying neural circuitry, and some predictions that emerge for future investigation.


\subsection{Oscillation as a principle of larval locomotion}
%KLDone\todoBW{cites in this paragraph and next need to be changed to bibtex}
%Larvae are known to display several typical behavioural features during chemotaxis \citep{green1983organization,cobbwhatandhow1999,gomez2012active}. They can show straight runs or curved runs mediated by small amplitude head-casts (i.e. the so-called weathervaning \citep{iino2009parallel,ohashi2014novel,gomez2014multilevel}, stop the crawling forward motion and display large head-casts, and resume forward motion in a new direction (i.e. so-called ‘turns’).

 Rhythmic behaviour is ubiquitous in biological systems. In some animals, such as {\it C. elegans} \citep{iino2009parallel,izquierdo2010evolution,lockery2011computational}  or the lamprey  \citep{lansner1997realistic,wilson1999spikes}, producing oscillations to drive the body segments is necessary because the body relies on lateral undulations for locomotion.
 In single amoeba cells \citep{yangzigzag2011}, as in many insects, oscillation about a heading direction can be observed even when direct forward motion is possible, and may have advantages for sensorimotor control when tracking up an odour trail  \citep{hangartner1969structure,farkas1972chemical} or plume \citep{budick2006free,belanger1996centrally,willis1997centrally,willis2008effects,carde2008navigational}  , when following a route \citep{lent2010image,kodzhabashev2015route}, or when approaching a visual target \citep{wallace1962experiments,philippides2013bumblebee,voss1998active}.

 %Our model assumes that underlying these features there is a regular and continuous left-right oscillation of the anterior body, and 
 We have presented evidence from larval tracking that such a rhythmic lateral oscillation exists (Figures \ref{fig:DynamicsExample} \& \ref{fig:GroupAnalysis}), apparently uncorrelated with the peristaltic rhythm (Figures \ref{fig:FigS1},\ref{fig:DynamicsExample}).
We take this continuous oscillation to be the underlying basis for larval behaviours that are often treated as distinct states triggered by dedicated sensory motor processes (see \cite{green1983organization,sawin1994sensorimotor, cobbwhatandhow1999,vogelstein2014discovery, gomez2012active, gomez2014multilevel, hernandez2015reverse,gepner2015computations}).
 That is, we suggest running/weathervaning and casting/turning all result from the same underlying and continuously active oscillatory mechanism (Figure \ref{fig:Peristalsis}C,D).
  Hence we would predict that it should not be possible to isolate distinct control circuits that trigger these apparently distinct actions: for example, genetically switching-off weathervaning without affecting high amplitude head-casts or vice-versa.

In this oscillatory taxis mechanism, ‘directed’ motion by the animal towards a target does not require a lateralised descending signal. Sensory information does not need to be segregated between left and right commands, nor does the agent need to know if it is currently moving left or right. The apparent ‘decision’ to turn left or right simply emerges from the interaction of the non-directional sensory signal with the current state of the oscillator. 

As a proof of concept that our hypothesis can work in continuous time, we have presented a possible neural implementation of the hypothesised oscillator, based on a lamprey CPG model (Figure \ref{fig:LampreyModel}).
 This model also reproduces taxis signatures and notably, similar variations in the duration and amplitude of the agent and larvae heading motion (compare Figure \ref{fig:DynamicsExample}A-C and \ref{fig:LampreyModel}E). It would be interesting to embed this mechanism into a biomechanical model of the larva body to investigate the detail body motion patterns observed during taxis. 
  We do not believe that the lamprey CPG is necessarily representative of the larva oscillator, and we are not aware of any direct evidence for a similar circuit in the larva, but several aspects of the neuroanatomy of the ventral nerve cord are suggestive \citep{kohsaka2012development}. Similar cross-connections are present in larvae all along the body \citep{rickert2011morphological} but only the cross-connections located in the anterior segments of the ventral nerve cord (VNC)(T1 T2 T3) seem important for initiating turning \citep{ berni2015genetic}, which is consistent with our model. Interestingly, these segments seem to be selectively targeted by multiple inputs connecting to both sides of the body, which may represent the non-lateralised commands modulating turning. Genetic disruption of the normal midline connection pattern showed that larva can still inhibit peristalsis (see discussion below) but seem unable to turn left or right and appear instead to contract both sides simultaneously \citep{berni2015genetic}. This is consistent with the idea that turns result from simultaneous bilateral modulation by the sensory inputs, and thus suggests that an intrinsic oscillator is required to obtain a lateralised motor response.
  
  %KL: Located rickert2011morphological refereing to 270 interneurons per seg and their corss connection patterns \todoBW{[additional references for existence of cross connection and other relevant motor circuit data]},
  
  One interesting corollary of this lack of internal representation of left and right motion is the prediction that an operant conditioning protocol that punished or rewarded turning (as viewed from the older framework: i.e. resuming the forward motion after a stop) towards one side of the animal would not work. It may nonethless be possible to affect the balance in the intrinsic oscillations themselves, but this should have an overall effect and lead the larva to keep curving towards the unpunished side.  


\subsection{Simple sensorimotor mapping}
%Inhibition and Excitation for attraction and repulsion.
We propose that the key mapping underlying taxis behaviour is a direct relationship of the perceived sensory signal to the modulation of oscillation amplitude.
As for classic klinokinesis \citep{benhamou1989animals}, which operates in the absence of oscillations, both the valence (attractive or aversive) and salience (strength of attraction or aversion) of the oriented response along a gradient of stimulus intensity is determined by the value of the effective gain $g$ by which the sensory signal linearly modulates the amplitude of turning. For instance in our abstract model, a high negative gain leads our agent to display a strong attraction, whereas, a low but positive gain will lead to a moderate aversion (Figure \ref{fig:PreferenceIndex}). This simple sign inversion is corroborated by evidence showing that antennal lobe (AL) glomeruli whose activity correlates with innate odour attraction send inhibitory projection (iPN) towards the lateral horn (LH); while glomeruli whose activity correlates with odour aversion send excitatory projections (ePN) \citep{liang2013gabaergic, knaden2012spatial}. 
%\todoBW{Citation needed!!}

Using an evolutionary algorithm, \cite{izquierdo2010evolution} generated a similar mechanism to explain taxis behaviour in {\it C.Elegans}, which, contrary to \Dros larvae, requires intrinsic oscillations for locomotion.
 In their model, these oscillations are regulated by both so-called ON and OFF cells. ON cells respond to up-gradient and down-regulate turns; and OFF cells detect down-gradient and up regulate turns, thus mediating attraction.
%%\todoML{Line 542: we have shown that a dual ON/OFF response can be achieved by a single OSN. Is it really necessary to invoke the existence of ON and OFF PNs? }KL: Added ref to say its been shown
  In the larva individual ORNs have been shown to give both ON/OFF responses \citep{schulze2015dynamical}, and thus up and down-regulation of the turns could be mediated by a same sensory neuron being depolarised or hyperpolarised.
   This is in accordance with the fact that there is usually a single PN for each glomerulus in \Dros \citep{ramaekers2005glomerular}, %KLDone \todoAW{(ref)}
 and explains how PNs with opposite valence can cancel each other into a neutral behavioural response (see supplemental material). If this is true, such a bidirectional modulation should be observable in single-functional ORN larva. 
  
\subsection{Phasic and tonic connections}
Our model assumes that larvae are able to perceive the change in odour concentration resulting from the displacement of the sensor. Electrophysiological recordings in larvae suggest that olfactory sensory neurons (OSNs) \citep{nagel2011biophysical,schulze2015dynamical} and projection neurons (PNs) do emphasize such differential concentration by showing a rapid adaptation: when stimulated by step odour input, they show a sharp peak of activation at the onset of the stimulus, and a depolarisation at the offset \citep{schulze2015dynamical}. In our models, this is represented by phasic connections, which transmit the derivative of the stimulus intensity.  

However, the increase in turning rate observed in the presence of an homogeneous concentration of fructose over the Petri dish \cite{schleyer2015learning} suggests that the neurons responding to fructose do not adapt fully and can mediate a sustained stimulation. This can be captured by our model using a tonic connection (Figure \ref{fig:Tonic}). Contrary to a phasic connection, a tonic connection does not adapt and thus transmits absolute stimulus intensity, which provokes in our model a sustained change in the larvae behaviour as long as it is exposed to the stimulus. This can enable the agent (e.g., a larva) to meander in an appetitive region (e.g, containing fructose) by increasing the number of turns and thus increasing the sinuosity of its trajectory; or conversely, to escape an aversive region (e.g., containing quinine) by decreasing the number of turns and thus straightening its trajectory \citep{benhamou1989animals}. A phasic connection on the other hand, by extracting the differential stimulation intensity, enables the agent to climb or escape a gradient of stimulus intensity. Thus, using a unique sensory-motor mapping, two functionally different types of behavioural responses can be mediated given the phasic (differential signal) or tonic (absolute signal) nature of the connections. All signals can simply sum up at the zone of convergence (Figure \ref{fig:Peristalsis}C). This view seems to be corroborated by \cite{hernandez2015reverse}'s results: optogenetic stimulations of olfactory and gustatory receptors show that larva turning probability correlates well with sharp change in stimulation intensity, but also to the sustained presence or absence of stimulation (\citep{gepner2015computations,hernandez2015reverse}).

In theory, any stimulus could provide phasic or tonic input to elicit either or both types of behaviour. In practice, neurons show complex adaptation responses and the difference between tonic and phasic responses may not be clear-cut. For instance, OSNs seem to not fully adapt to strong artificial step stimuli \citep{nagel2011biophysical, schulze2015dynamical} and thus may also mediate a different tonic signal across different background intensities. Conversely, tonic neurons showing nonetheless a quick enough response to variation in stimulus intensity can also convey differential information, and thus lead the agent to a slight tendency to climb or descent gradient of stimulus intensity. However, the differential response of such a tonic neuron would operate only across a short range of stimulus background intensity due to firing rate saturation. How specific is the phasic/tonic nature of neurons in larvae along the different pathways would constitute an interesting research agenda.

\subsection{Combining sensory inputs}
Our model proposes a simple solution for how multiple sensory inputs could be combined: simply sum the inputs from the respective sensory receptors (Figure \ref{fig:Peristalsis}C). For instance, a stimulus perceived by two receptors with respective gains of -1 and -2; will result in an overall effective gain of -3, that is, will trigger a stronger attraction than with any receptor alone. Two receptors with exact opposite gain would cancel each other, and lead the agent to ignore the stimulus. This property captures well the evidence that the summed response of the entire olfactory receptor array – taking into account the valence of each receptor – correlates with the strength of the behavioural response \citep{kreher2008translation} as well as the idea that gradual inhibition within the antennal lobe mediates habituation \citep{das2011plasticity} which would correspond to the gain slowly tending towards zero in our model. 
%%\todoML{Line 611: the “smooth” cancellation of odor attraction and light aversion doesn’t match our observations. If the light stimulation is discrete, larvae freeze even in their ascent of an odor gradient. After a while, they might habituate to the presence of light, which might explain Bellmann’s results. }  KL: In the quoted case the stimuli are not synced and so do not blend - especially in discrete light flashes.
Multiple modalities can be combined as easily, each influencing the taxis behaviour to the extent of their relative contribution to the effective gain (Figure \ref{fig:Peristalsis}C). This is consistent with the results of \cite{gepner2015computations} suggesting that larvae linearly combine olfactory and visual signals upstream of the decision to turn; as well as the apparent similarity of taxis behaviours observed across modalities (compare for odour: \citep{gomez2011active}; light: \cite{kane2013sensorimotor},   temperature: \cite{lahiri2011two}). In fact when aversive light stimulus and attractive olfactory stimulation are perfectly synchronized their antagonistic effects appear to blend smoothly (see \cite{bellmann2010optogenetically} Figure 1C). 

The subesophaegal zone could be a potential candidate for the convergence of the multiple sensory input, before the integrated signal is sent downstream to the motor circuitry \cite{tastekin2015role}. If that is true, the attractiveness of an odour should thus depend on the net weight of its output signal at this zone of convergence.  


\subsection{Integrating learning and motivation}

We can also model changes in behaviour observed in learning as a change of gain. Evidently, our models do not account for the complexity of the processing and function of real MBs. However, our results suggests that the output of the Mushroom body pathway \citep{gerber2004engram} may in part be viewed as an additional signal which also combines additively with the other pathways and thus participates to the overall gain (Figure \ref{fig:Peristalsis}C ). Thus the mushroom body can be thought of as a relay that modulates the valence and amplitude of its output signal to a specific pattern of input activation depending on the co-occurrence of appetitive or aversive reinforcers. The modulation of the signal can be achieved by adding new inhibitory or excitatory output connections or by changing the synaptic strength of pre-existing connections \citep{aso2014neuronal}. In either case, in our model the MB output signal is then combined with the signal of the innate pathways, participating to the overall gain and thus modifying the attraction or aversion behaviour to the trained odour.
 Note that in principle, any modality could avail itself of the mushroom body learning pathway, a dedicated innate pathway, or both (Figure \ref{fig:Peristalsis}C). 

The hypothesis that both learnt and innate signals simply sum up at their zone of convergence (Figure \ref{fig:Peristalsis}C), requires that the signal preserves differential information about stimulus intensity through the PNs, Kenyon Cells (KCs) and mushroom body output neurons (MBONs). Moreover, the MB pathway should be able to mediate an appropriate behavioural response independently of the innate pathway. This possibility is supported by the fact that artificial thermogenetic activation of ensembles of KCs can directly modulate temperature preference behaviour in adult flies \citep{vasmer2014induction}. 

%DoneK\todoBW{cites in this paragraph (and above?) need to be changed to bibtex}
Although not included in the current model, developmental \citep{gong2010two,wu2003developmental} and motivational \citep{krashes2009neural} %and contextual  \todo{ref?(Gerber review?)}
 effects could also be integrated by simply potentiating or inhibiting connections from specific stimuli. For instance, dNPF neurons, which encode satiety levels, could modulate the behavioural expression of innate or food-associated memory \citep{krashes2009neural}  by a simple modulation of the gain of these respective connections. Similarly, the current presence of sugar in the environment, which is known to prevent the expression of the odour-associated memory \citep{schleyer2011behavior}, could do so by simply modulating the MBON mediating this signal. 

\subsection{Integrating lateral oscillation with peristaltic motion}
By ignoring the peristalsis inhibition events observed in larvae, our models showed that peristalsis inhibition is not crucial for the emergence of the taxis signatures discussed above. However, it is clear that crawling speed can vary in larvae, including the sharp decrease towards zero speed correlated with the larger body bends (Figure \ref{fig:DynamicsExample} tail speed). How is crawling speed controlled? It could be that physical constraints lead to the peristaltic wave being disrupted by large turns, and indeed most higher amplitude turns are achieved when the peristalsis is inhibited (Figure \ref{fig:DynamicsExample}E, F; \ref{fig:FigS2}). However, our analysis (consistent with \citet{gepner2015computations,hernandez2015reverse}) shows that the inhibition of the forward motion is triggered on average at the onset of the turn and is thus clearly not a mere consequence of large body bends (Figure \ref{fig:Peristalsis}B). This suggests that a  command inhibiting peristalsis is sent when the larva is preparing for a large turn. Note, however, that this seems to be a graded response, the inhibitory command seems to vary in intensity and the peristalsis is not always completely interrupted (Figure \ref{fig:DynamicsExample}B, C).

Here we advance the tentative speculation that both the turning oscillator and the peristaltic wave might be continuously modulated by the same signal (Figure \ref{fig:Peristalsis}C), 
%  If peristalsis inhibition is mediated by a separate signal, it should be possible to switch off oscillations and peristalsis inhibition independently. However
%[AW-not really as persistalsis inhibition could receive additional signal, from body wall for instance].
%that is, sensory inputs are combined into a same signal before being sent to both lateral oscillation and peristalsis modulation. 
If this is true, then average speed, frequency of stopping events and average body bending amplitude should co-vary across stimuli conditions (with speed inversely correlated to the two others). Indeed, \cite{gomez2014multilevel} reported that larvae tend to accelerate when they move up-gradient - which is correlated with a reduced turn rate \citep{schleyer2015learning} - and decelerate when they move down-gradient - which is correlated with an increased turn rate \citep{schleyer2015learning}. This seems to suggest the existence of a continuous, quantitative, modulation of the peristaltic motion. 

However, the observed crawling speed is not purely continuous: contrary to turning amplitude, the tail speed distribution is bimodal (Figure \ref{fig:Peristalsis}A).
 This does not necessarily imply that the descending signal is discontinuous, as the discontinuity could be due to the nature of the embodied peristaltic wave propagation dynamics. These could rely on positive feedback from stretch-rate receptors \citep{ross2015model} giving rise to non-linear dynamics that could be responsible for the abrupt disruption of the peristaltic wave's propagation. While weak signals may modulate crawling speed, a strong enough signal may disrupt the peristaltic wave propagation, leading effectively to a stop (Figure \ref{fig:Peristalsis}D).
  This hypothesis could be tested as follows: any tonic stimuli having an impact on average crawling speed should have the opposite impact on the frequency of peristalsis inhibition events; and it should be possible to target optogenetically efferent connections towards abdominal segments that regulate speed, but also disrupt the peristalsis with stronger activation.

\subsection{Conclusion}
%doneKL\todoBW{cites in this paragraph (and above?) need to be changed to bibtex}
% \todoKL{Add that responses are state dependent. Also, clarify our model not in larva full complexity, but targets what we think is the primary driver behind taxis. In reality more modules and dynamics must be at play. However we stress ...it's awesome}
Larval taxis behaviour has been characterised as transitions between discrete states, or actions \citep{green1983organization,sawin1994sensorimotor, cobbwhatandhow1999, gomez2012active}  requiring ‘action-selection’ or ‘decision-making’ processes \citep{gomez2014multilevel}. Here we presented an alternative hypothesis where taxis results from a single simple sensory-motor process (Figure \ref{fig:Peristalsis}C): sensory signals directly modulate the continuous lateral oscillations of the anterior body that we observed in larvae (Figure \ref{fig:DynamicsExample}). In effect, this process can be continuous so the animal does not need to take decisions. 
Evidently, our models do not represent at all the full complexity of real larvae neural processing and body mechanics. However, despite their simplicity, they can capture a remarkable number of taxis phenomena observed in larvae, which suggests that the hypothesis they embed reflects a core mechanism operating in larvae for taxis. Under this light, explicit neural representations of actions such as curved-run vs. turn or left vs. right are not required for the animal to perform taxis. Instead, these apparent `decisions' emerge from dynamic interactions operating in the brain-body-environment loop.

An elegant picture emerges from this view. All type of sensory signals, tonic or phasic, mono or multi-modal, can combine by simply converging on the single process that lies at the core of taxis. Additional new features such as different sensory receptors or intermediate relays such as MB can be directly integrated to impact on behaviour in a meaningful way. Their respective influence can be modulated by changing the intensity of their signals. Thus taxis behaviour can be accommodated to new environmental conditions without modifying or requiring new sensory-motor processing. It has been argued that over long time scales, natural selection favours not merely effective innovations, but systems that flexibly enable the incorporation of innovations \citep{vermeij1973adaptation}. The modularity of the system described here could provide such an evolutionary flexibility since it allows taxis behaviour to adapt by simply plugging-in or removing input modalities.

Investigating how this system can operate within the complexity of larvae body mechanics, additional neural processes and the various tasks larvae perform in natural environments should form an interesting future research agenda.

%TC:break _METHODS_
%TC:ignore
\section{Materials And Methods}
\subsection{Real larvae path analysis.}
We analysed the tracks from 42 wild type larvae, the data recorded for \cite{gomez2011active}, which was supplied by Matthieu Louis. Each 3rd-instar foraging-larva path was recorded for 5 min at 7fps after releasing each larva on a rectangular agarose slab opposite to an odour source given by an ethyl butyrate droplet suspended from the lid.
 Tail, centroid and head positions were extracted from each frame of the video using custom tracking software.
 Having obtained the processed data we used Matlab to analyse the tracks.
  Body bending was calculated as the angle formed between the tail-to-centroid axis and centroid-to-head axis. The variable ‘angular velocity of the anterior part of the body’ was obtained as the derivative across time of the centroid-to-head axis orientation. Specifics of the path analysis are presented where appropriate in the result sections. 

\subsection{Agent-based simulation in discrete time steps}
\label{sec:methodsDiscreteAgent}
The agent model is an abstract description of the mechanism we believe larvae use to move up or down stimulus gradients. 
The model runs in discrete time $n \in \{1 \cdots N\}$, it consists of a point with position $x_n,y_n$ and an associated orientation $\theta_n \in {-2 \kappa \pi,+2 \kappa \pi}$.
 The following update equations of state variables summarize the agents algorithm when executed in the order that they appear below for each time-step :

\begin{align}
\theta_{n} &\leftarrow \theta_{n-1} + H(\theta_B + g (s_{T} + \nabla s_{n-1})){(-1)}^n\\
x_n & \leftarrow x_{n-1}+ \lambda \cos \theta_{n} \\
y_n &\leftarrow y_{n-1}+ \lambda  \sin \theta_{n}\\
s_n &\leftarrow C(x_n,y_n)\\
n &\leftarrow n+1
\label{eqn:Discretemodel}
\end{align}
assuming initial conditions for $s_0 = 0$ and a random initial position set for $x_n,y_n$ and orientation angle $\theta_0$.
In the equations above $g$ is the gain, $\nabla s_{n}  = s_{n} - s_{n-1}$ represents the change in the sampled stimulus between two time steps,  at each time-step the agent moves by $\lambda$,  $H(x)$ is a hardlimit function :
\begin{equation}
H(x) =
\begin{cases}
x \mbox{ if } 0 \leq x \geq \pi \\
\pi \mbox{ if } x > \pi  \\
0 \mbox{ if } x < 0 
\end{cases}
\label{eq:boundary}
\end{equation}

According to the above algorithm, at each time-step $n$ the orientation $\theta_n$ is first updated under the influence of an intrinsic  turning pattern, alternating left and right for odd and even time-step. 
This pattern represents the observed continuous oscillation of heading direction, which is driven by the orientation of the larva's anterior body.
 The baseline amplitude of this lateral oscillation is set to the baseline angle $\theta_B$.
  In the presence of environmental stimulation, the baseline angle is modified by two types of inputs: A phasic signal $\nabla s_{n}  = s_{n} - s_{n-1}$, which corresponds to the change of stimulus intensity perceived between two time-steps, and, optionally, a tonic signal $s_{T}$, which corresponds to the absolute stimulus intensity perceived at a given step.
After re-orientation, the agent moves by a step $\lambda$ in the direction $\theta_n$. The new sensory samples $s_{n-1}$ are then updated and the algorithm increases the time-step to $n  \leftarrow n+1$ and starts a new cycle.

The function $C(x,y)$ could be a fixed odour-gradient map, or a bivariate normal distribution (see eq. \eqref{eqn:bivariateNormal}) can be used to represent the distribution of odour concentration around an odour source. 
 The maps of odour gradients used in our simulations have been provided by Matthieu Louis' Lab, as recorded in \citep{gomez2014multilevel}. Stronger odour source concentrations were modelled by simply scaling the gradient map.
If the agents hits the boundary of the odour gradient map, a new  orientation is randomly assigned so the agent keeps within the boundaries.

A negative gain $g$ with a positive $\nabla s$ (i.e. an increase in concentration perceived) on one step would lead to a decrease in turning away at the next step (up to the lower boundary of $H(x)$), while a negative $\nabla s$ (i.e. a decrease in concentration perceived) will lead to an increase in turning away  on the next step (up to the higher boundary of $H(x)$).
 The resulting paths tend to be directed away from the odour source.
 In contrast a positive gain would mediate repulsion.

In some conditions we added noise (see results). The additive noise is modelled simply as :

\begin{equation}
\theta_{n} \leftarrow \theta_{n-1} + H(\theta_B + g (s_{T} + \nabla s_{n-1})){(-1)}^n + Z_n,
\end{equation}

where $Z_n$ is drawn from normal distribution and then added to the agent's current heading angle. 
 
\subsection{Agent-based simulation in continuous time}
\label{sec:methodsCoupledOscillator}
The continuous agent is abstracted to an oriented point-sensor (as in the discrete-time model) but now, critically, the change in heading is driven by a model of coupled neural oscillators.
We use the single-segment model of the lamprey \citep{lansner1997realistic} to represent the neural oscillator driving the change in heading of the agent.

% Activity measured using using calcium bioluminance reporters  showed an asymmetry in the VNC's neurons wave-like activity between the left and right thoracic segments \citep{berni2015genetic}.
%  We model such activity by a pair of compartments each producing the respective larval orientation body.
%   To simplify our model we consider the response of the premotor neurons only without an explicit model of the driven motor neurons.

The CPG consists of a pair of compartments, here taken to driving changes in heading of the agent (Figure \ref{fig:LampreyModel}A). 
Each compartment contains a pool of excitatory neurons $E$ and a cross-inhibitory interneuron $C$, which projects to the opposite compartment.
 The $E$ unit of Figure \ref{fig:LampreyModel}A with its self-connection therefore stands for the activity of a pool of excitatory neurons that interconnect within the compartment and project to the $C$ inhibitory neuron, while both  $E$ and $C$ receive an inhibitory connection from the $C$ neuron of the opposite compartment.
  Further the $E$ neurons of both compartments receive input from the $A$ unit, which represents pooled sensory input, and a modulatory influence from the $S$ unit, whose effects will be described shortly.


Our model is based on the version of \cite{wilson1999spikes} of the lamprey simplified model \citep{lansner1997realistic}  according to which the neuronal responses are given at the spike-rate level given by the \cite{naka1966s} function:
\begin{equation}
\label{eq:nakarushton}
R(x,h) = \begin{cases} 
\frac{m x^n}{h^n + x^n} &\mbox{if } x \geq 0 \\
0 						&\mbox{if } x < 0
\end{cases},
\end{equation}
which maps the stimulus intensity $x$ of the net synaptic input to the expected spike-rate response of a neuron. The parameter $h$ sets the half-response threshold while $n$ sets the steepness of the response.
 Since spike-rates can only take positive values and therefore the function is constrained to lie positive integers up to the maximum $m$, which here will be set to $m=100$ throughout.% we will denote this constraint as $[x]_+$. 
Each neuron also accounts for spike-rate adaptation effect due to a slow after hyperpolarization potential current $I_{AHP}$, which operates by raising the half-response threshold $h(t)$ of Eq. \eqref{eq:nakarushton}.
 The equations for the left side of the coupled oscillators we examine are as follows:
\begin{align}
\tau \frac{dE_L}{dt} & = - E_L +  R( A + W_{ee} E_L - W_{cc}C_R, 64 + g(A)H_{EL})\\
\frac{H_{EL}}{dt} &= \frac{1}{\tau_H(A)}(-H_{EL}+E_L)\\
\frac{dC_L}{dt} &= -C_L + R(100, A + W_{ce}E_L - W_{cc}C_R, 64+g(A)H_{CL})\\
\frac{dH_{CL}}{dt} &= \frac{1}{\tau_H(A)}(-H_{CL}+E_L),
\end{align}
where $E_L, C_L$ represent the excitatory and cross inhibitory neuron of the left compartment in Figure \ref{fig:LampreyModel}A, while the $H_{X}$ represents the dynamics of the $I_{\text{AHP}}$ of a neuron, $R(x,h)$ is the \cite{naka1966s} function of Eq. \eqref{eq:nakarushton}, and $W_x$ are the synaptic weights shown on Figure  \ref{fig:LampreyModel}A. On the same figure we see that the neuromodulatory unit $S$ connects to both compartments, its effects are exerted via modifying the time-constant and gain of the $I_{\text{AHP}}$:
\begin{align}
g(A) &= 6 + \left( 0.09A \right)^2\\
\tau_H(A) &= \frac{35}{(1 + 0.04 A^2)},
\end{align}
where an increase in the input from $A$ will result in an increase of the $I_{\text{AHP}}$ gain and a decrease in its time constant $\tau_H$.
 The neural model has the respective equations for the right compartment, containing  $E_R$ and $C_R$ for the right side oscillator:
\begin{align}
\tau \frac{dE_R}{dt} & = - E_L +  R( A + W_{ee} E_R - W_{cc}C_L, 64 + g(A)H_{ER})\\
\frac{H_{ER}}{dt} &= \frac{1}{\tau_H(A)}(-H_{ER}+E_R)\\
\frac{dC_R}{dt} &= -C_R + R( A + W_{ce}E_R - W_{cc}C_L, 64+g(A)H_{CR})\\
\frac{dH_{CR}}{dt} &= \frac{1}{\tau_H(A)}(-H_{CR}+E_R),
\end{align}

%Continuous Model
To represent the biophysical constraints on re-orientation due to body-bending in real larvae we  used an idealized linear spring-mass-damper acting on the change in heading of the agent see Figure \ref{fig:LampreyModel}B.
The system uses a pivoting spring-damper-mass on a joint to represent the elastic and damping forces exerted by the surrounding cuticle under the influence of opposing muscle forces driving body-bending in larva.
 The muscles would normally be driven by motor neurons, but here we simplify by assuming that the motor neurons replicate the activity of the $E_L$ and $E_R$ pre-motor neurons and thus the later can be directly used.

The agent continuously moves at speed of 1mm/sec in the direction indicated by the body angle $\theta$. This simplification is justified in terms of our finding that the peristaltic wave peaks are uncorrelated with the body bending and thus can be taken as slow motion of the posterior body segment following the heading direction indicated. However, our model does not capture the straightening of the body bend due to this motion, or the friction forces exerted from the contact with the ground withholding the restoration. Given that the oscillation is driven by the premotor neuron activity and that the larva is assumed to continuously move at constant speed the details of how the body bending is restored have been simplified out in our model to be driven by restorative elastic forces of the body. 
 We take a non-dimensionalized approach writing the muscle model driving the head as second order system of idealized spring-mass-damper \cite[see][]{fung2013biomechanics}:
\begin{equation}
\label{eqn:headmodel}
\frac{d^2\theta(t)}{dt^2} = - 2 \zeta \theta'(t) - (\theta(t)) + (E_L(t) - E_R(t)),
\end{equation}
where $\zeta= \dfrac{\eta}{ 2\sqrt{k \gamma}}$ defines the damping ratio, with $\eta$ the damping force coefficient, $k$ the stiffness coefficient of a linear spring and $\gamma$ the muscle gain.
We assume muscles on each side of the body work against each other to change the heading and thus in this two dimensional model the net torque produced is taken to be the difference in spike rates of the premotor neurons $E_L(t) - E_R(t)$ driving the muscles on each side. 
Evidently the system is not representative of the larval muscle activity but the change in orientation caused by this activity.
 Nevertheless, it allows us to examine an embodied sensory-motor process during chemotaxis in continuous time avoiding the use of a detailed body that in essence would still only describe the motion of the olfactory sensor at the larva model which is needed for our demonstration.
 Further, writing the system in this form allows us to avoid having to consider specific values for the parameters and examine a generic system described by a level of damping, for which we have chosen an intermediate value $\zeta=1/2$.
The translation of heading angle $\theta$ of Equation \ref{eqn:headmodel} to a bearing $B$ is via a simple integration. Bearing is then converted to Cartesian coordinates to indicate the position of the head as a point:
\begin{align}
\frac{dB}{dt} &= \theta(t)/10 \\
\frac{dx}{dt} &= \sin{\dfrac{B(t)}{10}} \\
\frac{dy}{dt} &= \cos{\dfrac{B(t)}{10}}
\end{align}
   
Lastly, we define the $A$ neuron's activity pattern which we assumed to be representative of an olfactory sensory neuron. $A$'s output is a combination of a tonic output $b_T$ , which is required to maintain the oscillation but also influences the oscillation frequency \cite{lansner1997realistic}, along with the derivative of the odour concentration $S(t)$ superimposed : 
\begin{equation}
A(t) = b_T + G \frac{dS}{dt},
\end{equation}
where $g$ defines the gain defining how much the derivative of the sensory stimuli alters the firing  rate of input $A$, which perturbs the motor patterns and in turn influences the sensed stimulus in a closed-loop such that the rhythmic behaviour generates input for adaptive control \cite[see][]{willis1997centrally}.
The sensory stimuli is drawn from a virtual odour gradient that is simply taken to be a scaled bivariate normal distribution:
%\todoKL{Needs a fix here. Maybe not show it explicitly}
\begin{multline}
m(x,y) = \frac{1}{2 \pi  \sigma_x \sigma_y \sqrt{1-\rho^2}}\\
      \exp\left(
        -\frac{1}{2(1-\rho^2)}
        \left[
          \frac{(x-\mu_x)^2}{\sigma_x^2} + 
          \frac{(y-\mu_y)^2}{\sigma_y^2} -
          \frac{2\rho(x-\mu_x)(y-\mu_y)}{\sigma_x \sigma_y} \right]\right)
\label{eqn:bivariateNormal}
\end{multline}
with $\rho = \frac{\Cov(x,y)}{\sigma_1 \sigma_2}$ being the correlation of $x$ and $y$.
The sensory information as a function of time is then given by :
\begin{equation}
S(t) = C m(x(t),y(t)).
\label{eq:SensoryFunction}
\end{equation}
The model system was evaluated numerically using mathematics software from \cite{math}
using the parameter set and initial conditions listed on Table \ref{tbl:OscparameterSet}.
 For our purposes the choice of parameters was broad and any arbitrarily set that has sufficiently strong contralateral inhibition $W_{cc}$ such that the left-right oscillators quickly lock in antiphase while the frequency of the oscillation falls approximately within the larval range of 0.5Hz was sufficient. The frequency of the heading-oscillation was examined using a Fourier transform (see supplementary material).
% We find that the behaviour arises over a wide set of parameters, however this analysis is deferred as our current focus is demonstrating the feasibility of such a neural system for taxis. For our demonstration we used the parameter set on Table \ref{tbl:OscparameterSet}. 

Further, we examined the change of bearing in response to a step change in the input firing rate of $A$.
 For these results we removed the system of neural oscillators coupled to the head-model from the odour environment and examine the change of bearing in response to step increase of amplitude $A_m$ in the input arriving from neuron $A$ at various time points $t_s$:
\begin{equation}
A(t) = b_T + A_m U(t-t_s),
\end{equation}
where $U(t)$ is the unit step function with an onset time at $t_s$. The change of bearing was measured by integrating the head angle for long enough time for it to settle back to its cycle of zero-average change of bearing. Each curve of \ref{fig:LampreyModel}F consist of $10^2$ points covering $t_s$ timing over a full cycle of oscillation (ie. from one peak of $E_L$ burst to the next), while each curve differs in the step amplitude $A_m$.


\section{Acknowledgements}
We are grateful to Matthieu Louis for providing us with larval tracking data and for his feedback on our manuscript. This work was supported by EU FET-Open grant MINIMAL.

\newpage
\section{Figures}


\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig1_dynamics_example.pdf}
\caption{{\bf Examples of larva motion dynamics during chemotaxis show lateral oscillations.} 
Left side shows the angular speed of the anterior part of the body (blue), body bending (black), and peristaltic steps (grey dotted lines) based on tail speed (green) corresponding to the paths shown on the right. Number labels link particular events. 
{\bf A.} Section with no peristalsis inhibition. The larva shows a continuous alternation between left and right but turning is biased in both intensity and duration towards positive angles, resulting in a left curve.
{\bf B.} Section with an intermediate (1) and two stronger (2 and 3) peristalsis inhibition events, which do not interrupt turning alternation.
\label{fig:DynamicsExample}
}
\end{center}
\end{figure}



\begin{figure}
\ContinuedFloat
\caption{
{\bf C.} Section including a peristalsis inhibition event covering two successive turns (4 and 5). The green bars (1 and 2) indicate moments at which the body bending decreases (from left to right) even though the larva anterior body is still slightly swinging towards the left. This is due to the simultaneous forward peristalsis motion bringing the posterior part of the body towards the axis of the anterior part. Angular speed of the anterior body provides thus a better proxy than body bend to infer the control commands involved.
 {\bf B,C.} Red dotted lines indicate onset of peristalsis inhibition (conservatively late measure) which occurs before strong angular speed change or body bending. 
%Kl:I think AW fixed this\todoBW{Not clear what 'relative distribution' means. Also tail speed ratio becomes meaningless with few data points at high velocity, could cut off the curve}
% no longer in this figure: Full Red line shows ratio of data that are higher than current x value. Black line shows the ratio of such data (higher than current x value) that are below the tail speed threshold (black dash line). Although there are no clear cut categories, anterior body angular velocity seems a better predictor of peristalsis inhibition than body bending.
}
\hrule
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig2_group_analysis.pdf}
\caption{{\bf Group statistics of larva motion dynamics during chemotaxis support the existence of an intrinsic lateral oscillatory rhythm.}
{\bf A,B.} Average ($\pm 95\%$CI) dynamics of the anterior body angular velocity (blue), body bending (black) and tail velocities (green) displayed before and after peristalsis inhibition events aligned at $t=0$ (dashed red line, when tail speed drops to a minimum), and categorised according to whether the larva is sweeping towards the left ({\bf A}) or right ({\bf B}) at $t=0$. Drops in forward crawling speed tend to be accompanied by a large head cast, as shown previously \citep{hernandez2015reverse} (see supplemental Figure \ref{fig:FigS2}). Large head casts are preceded by low amplitude head casts in the opposite direction (arrows), suggesting the large head cast direction is dependent on the state of the oscillation. (Continued)
}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\ContinuedFloat
\caption{
{\bf C.} Fourier analysis of the angular velocity of the anterior body (blue) and tail speed (green) across all larvae (see inset for a single individual). Tail speed (peristalsis) rhythm is fairly constant across larva at around 1.0Hz, with slight harmonics of the tail speed at 0.5Hz, which results from the tendency of some larvae to alternate continuously between a weaker and stronger peristalsis wave (see \ref{fig:DynamicsExample}A) tail speed for an example). The angular velocity of the anterior body (blue) shows a slower rhythm than the peristalsis, with a higher variation across and within individuals. Note that the rhythms are not multiples of each other, suggesting that they are operating independently (see also Figure \ref{fig:FigS1}).
 {\bf D.} Distributions of markers of the anterior body sweeps (see inset for logarithmic scale) reveal no sign of bimodality, suggesting a a continuum of turning modulations rather than the triggering of distinct specific actions.
\label{fig:GroupAnalysis}
}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig3_method_agent.pdf}
\caption{
{\bf Discrete agent simulation.}
{\bf A.} The agent consists of an oriented point (black dot) which samples odour concentration at this location. The red line indicates the direction from which the agent is coming, and the grey arrow indicates the direction in which it will depart. At each time step, the agent performs a rotation on the spot alternating between left and right rotations (`L' and `R') so as to set a new orientation (grey arrow), and then goes forward 1mm in this new direction. The extent of this rotation ($\alpha$) is constrained between 0 degrees (i.e. the agent would then carry on in the same direction) and 180 degrees (i.e. the agent would then perform a U-turn), as indicated by the dashed line.
{\bf B.} In the absence of stimulation, the extent of this rotation is set according to a constant baseline $\theta_{B}$ (typically $\theta_{B}$=10deg, but it is exaggerated in this depiction), so that the agent would go on alternating between left and right small turns in a zig-zag fashion.
 In the presence of stimulation, the extent of the rotation (e.g., towards the right) is modulated by the change of stimulus intensity (blue line, $\nabla s$) perceived between the previous (tn-1) and current (tn) position. This modulation depends on the agent's gain $g$, which is constant; so that the extent of the rotation (here towards the right) is: $\alpha=\theta_{B}+g\times\nabla s$. (Continued)
\label{fig:MethodAgent}
}
\end{center}
\end{figure}


\begin{figure}
\ContinuedFloat
\caption{
As a result, if the gain is negative ($g<0$), an increase in stimulus intensity perceived ($\nabla s>0$) would decrease the extent of the rotation towards 0 degrees (i.e. the agent would then carry on in the same direction), whereas a decrease in stimulus intensity perceived ($\nabla s<0$), would increase the rotation up towards 180 degrees (i.e. the agent would then perform a U-turn). Effectively, such a negative gain ($g<0$) yields attraction towards higher stimulus intensity. Inversely, a positive gain ($g>0$) yields aversion ({\bf D}), and a null gain ($g=0$) yields neither attraction nor repulsion.
{\bf C,D.} Examples of a section of path taken by the agent in an odour gradient. Black dots indicate the locations of the agent, where the odour concentration is sampled across successive steps. Red line indicates the direction from which the agent is coming, and the underlying dark continuous line indicates the overall path taken by the agent. The blue lines indicate the isoclines of the odour concentration.
}
\hrule
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig4_orbital.pdf}
\caption{{\bf Typical path signatures for larvae and simulation.} {\bf A,B.} Example of paths. {\bf C,D.} Distributions of bearings to odour.
 Both larvae and simulated agent tends to spend most time with the odour located on their sides (-90 and 90 degrees), orbiting the source. In both larvae and simulation, orbital behaviour is emphasized during peristalsis forward motion (turn $<30$ degrees for the model) ({\bf C}. blue curve), and when the larvae/agent is more than 1cm away from the odour ({\bf D}. green curve). Crossing-over trajectories, by contrast, are constituted of regular large turns that happen mostly while the larvae/agent is heading away from the odour ({\bf C.} red curve), and is rather apparent when the larvae/agent is close to the odour ({\bf D.} blue curve).
\label{fig:PathSignatures}}
\hrule
\end{center}
\end{figure}



\begin{figure}
\begin{center}
\includegraphics[angle=-90,width=145mm]{figures/Fig5_Paths_across_gain_BMP.pdf}
\caption{{\bf OSN input and signal-to-turn modulation gain.}
{\bf A.} Time occupancy spatial maps for genotypes with re-engineered peripheral olfactory circuits tested in the near-source paradigm (30 mM odour source): wild type (N=42 flies), Or42a ectopically expressed in the 21 intact ORNs (all neuron pairs active, N=38), Or42a single-functional ORN (one pair of neuron active, N=37), and Orco null (anosmic flies, N=55) reproduced from \cite{gomez2011active}.
{\bf B}) The simulated agent given different gains $g$ can capture the patterns observed in larvae; suggesting that activity of the OSN simply sum up so that higher activity as a group leads to a stronger turning modulation signal.
%KL:Done \todoBW{Have we explained anywhere how agent behaves at boundaries (takes random direction)? Should add to end of methods section 4.2?}
\label{fig:OSN}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig6_conc_learn.pdf}
\caption{{\bf Effect of odour concentration and appetitive conditioning on bearing to odour distribution and rate of turns.} {\bf A,C.} Real larva data are drawn from \citep{schleyer2015learning}. {\bf B,D}. In our simulation (shows mean $\pm$ standard deviation) turning events were categorised as large turns if $>30$ degrees and not followed by another large turn. Changes in concentration were obtained by multiplying the gradient by a factor 0, 1 or 2. Learning was modelled as a change in gain ($g=0$, $g=-2$ or $g=-5$). The same qualitative changes in turn angle and turn rate relative to odour bearing are observed.
\label{fig:Concentration}}
\hrule
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig7_Pref_indexes.pdf}
\caption{{\bf Preference index and robustness to noise. }
{\bf A,C}. Preference index ($(N_{odour-side}-N_{other-side})/N_{total}$) for 30 simulated larvae after 3 minutes, for different gains. {\bf B,D.} Final distance to odour 
{\bf A,B.} Given biologically relevant bounds, the preference index seems to vary linearly with  gain $g$. For comparison, real larvae data (grey boxes) are drawn from appetitive learning in \citep{schleyer2011behavior}.
{\bf C,D.} Impact of noise on preference index (C) and distance to odour (D). Noise values correspond to the standard deviation of the normal distribution from which the noisy angle is drawn at each step. The linear effect of gain change remains evident at high noise levels.
%\todoBW{Could consider removing B,D; they don't add much information}
\label{fig:PreferenceIndex}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[angle=-90,width=145mm]{figures/Fig8_gustatory_index_BMP.pdf}
\caption{{\bf Effect of presence of fructose and tonic signal.}
{\bf A.} Increased turn rates in larva in the presence of fructose (top; drawn from \citep{schleyer2015learning}) can be replicated by the presence of a tonic signal in our simulation (bottom; see Figure \ref{fig:Concentration} for definition of reported measures). 
{\bf B.} Gustatory index as calculated by the ratio of 30 simulated larvae ending up on the fructose side/other side after 3 minutes is shown across signal-to-turn modulation gain for phasic and tonic signals. Only negative gain response to a phasic signal seems to explain the positive gustatory index shown in real larvae in presence of fructose \citep{schleyer2011behavior}.
{\bf C,D.} Example of section of paths taken by the agent illustrating response to phasic (left) and tonic (right) signal in the presence of fructose (green area).
%\todoBW{I'm not sure what is explained in Figure \ref{fig:Concentration} that is usefully specific here?}
\label{fig:Tonic}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig9_sensory_exp.pdf}
\caption{{\bf Sensory history and monotonic decrease in concentration.} {\bf A,B.} Example of simulated path and the associated sensory history given the absolute and differential odour concentration perceived.
{\bf  C.} Average ($\pm 95\%$CI) and individual’s example of the sensory history experienced before and after large turn events ($>90$ degrees) in our simulation. For all large turns (black), or only the large turns that result in experiencing a positive (red) or a negative $\nabla s$ (blue). A slow monotonic decrease in concentration precedes large turns even though turns are the consequence of the signal experienced during the previous step only.
\label{fig:SensoryHistory}}
\hrule
\end{center}
\end{figure}

%[!ht]
\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig10_bias_correct_side.pdf}
\caption{{\bf First turn bias towards the correct side.} First turns were categorised as large turns (turn $>30$ degrees) that were not preceded by a large turn at the previous timestep.
{\bf A.} Probability of turning to the correct side (i.e. towards the odour; 1st column ‘C’) and wrong side (second column ‘W’). Higher signals (i.e. increased concentration or stronger gain 'g') increase the bias.
{\bf B.} Turning direction (mean $\pm$ standard deviation) given the bearing to odour. Green and red zones indicate turn towards (i.e. correct side) or away (i.e. wrong side) from the odour respectively. Noise $Z = 10$. Time $t=800$. $N=1000$ larvae ($n > 25000$ for each group)
\label{fig:FirstTurn}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=135mm]{figures/Fig11_continuous_model.pdf}
\caption{{\bf Neural model in continuous time.} {\bf A.} Central pattern generator modelled with neurons of mean firing rates  \citep[adapted from ][]{wilson1999spikes}.
  Arrows indicate excitatory connections, a bar denotes an inhibitory connection and circle denotes a neuromodulatory connection. Cross inhibitory connections go to all neurons of the opposite compartment.
   The $A$ unit represents mean firing rate of an OSN, and it projects to both compartments.
   The $S$ unit represents a neuromodulatory neuron which  modulates the half-response threshold of the $E$ and $C$ neurons  to effectively imitate the effects of a slow adapting current. We denote the left and right $E$ as $E_L$ and $E_R$ respectively.
{\bf B.} A torsional spring is acting on the agent heading change to represent the restoring viscoelastic forces of the larva body bends. The red arrow indicates the direction from which the agent is coming, and the grey arrow indicates its heading direction.
{\bf C.} Frequency of heading oscillations that are comparable to data.
{\bf D.} Example chemotax trajectories in a virtual odour gradient with different gain.
{\bf E.} Model dynamics during chemotaxis trajectory, showing $E_L$ and  $E_R$, $\theta'$ and the $A$ input as influenced by the moving larva in the environment. Under high-gain the turns appear sharper.
{\bf F.} Effects of unit-step perturbations on bearing angle across across oscillator phase.
 Panels below show the simultaneous state of the heading angular velocity, an example step-up in the firing rate of $A$ and the respective state of neural bursts from $E_L$ and $E_R$ (here shown unperturbed by the step-input $A$).
%KLDone\todoBW{plot refers to L and R oscillators rather than  $E_L$ and  $E_R$}
\label{fig:LampreyModel}}
\hrule
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=145mm]{figures/Fig12_discussion.pdf}
\caption{{\bf Oscillations and peristalsis modulations.} {\bf A.} Real larvae tail velocities show a bimodal distribution, with the first peak corresponding to peristalsis inhibition events. Inset illustrates the extraction of maxima peaks (red curve) of tail velocities.
{\bf B.} Average ($\pm 95\%$CI) of the tail velocities (green) and absolute values for the anterior body angular velocity (blue) and body bending (black) displayed before and after peristalsis inhibition events (aligned at t=0, when tail speed dropped to a minimum). Red line highlights that average tail speed velocity (green) starts dropping before the occurrence of large increase of body bending (black) or anterior body angular velocity (blue). This suggests that tail speed is not a mere physical consequence of large turning event.
{\bf C.} Conceptual scheme illustrating our overall view: all modalities, innate and learnt, tonic (full line) or phasic (dashed line) signals are integrated at their zone of convergence. The summed signal is sent to both 1-the  neural oscillator mediating turning of the anterior body (blue), and 2- neurons mediating peristalsis inhibition (green).  Associative center (Asso center), such as the mushroom body, where signal weightings can be modulated given the co-activation of a reinforcer neuron (R).
\label{fig:Peristalsis}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\ContinuedFloat
\caption{
{\bf D.} Qualitative prediction of average anterior body angular velocity (blue) and tail speed velocities (green) as a result of the summed sensory signal perceived. Growing signal strength increases anterior body turning and inhibits crawling speed simultaneously. If the signal is sufficiently strong peristalsis disruption happens, leading to an abrupt drop of tail speed velocities. The relaxing of the  peristaltic synchronous left-right body contraction enhances the reaction to the thoracic left-right asynchronous oscillatory contraction, thus resulting in sharp increase in body turning. Peristalsis spontaneously resumes when the sensory command lowers below peristalsis disruption threshold. Thus one continuous control signal could explain the emergence of straight runs, weathervaning and the stop and head-casts actions observed in larvae.
}
\end{figure}


\include{NeuralOscillatorSuppContent}


\clearpage
\bibliography{NeuralOscillatorPaper}
%TC:endignore 

%\section*{wordcount without materials methods}
%\newcommand\wordcount{ \verbinput{ wordcount.tex}}
%\wordcount

\end{document}



