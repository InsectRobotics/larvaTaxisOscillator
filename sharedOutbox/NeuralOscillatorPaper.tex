\documentclass[11pt,a4paper]{article}
\parskip=12pt % adds vertical space between paragraphs
\renewcommand{\baselinestretch}{1.5} 

\addtolength{\oddsidemargin}{-.275in}
	\addtolength{\evensidemargin}{-.275in}
	\addtolength{\textwidth}{0.75in}

	\addtolength{\topmargin}{-.275in}
	\addtolength{\textheight}{0.75in}

\usepackage[utf8]{inputenc}
\usepackage[comma,authoryear]{natbib}
\bibliographystyle{plainnat}

\usepackage{lineno}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
%\usepackage{subfigure}
\usepackage{caption}
\usepackage[colorinlistoftodos]{todonotes}   % notes showed

%\usepackage{verbatim}
%\usepackage{moreverb} % for verbatim ouput
\usepackage{sverb}
\usepackage{hyperref}


% Count of words
\immediate\write18{texcount -inc -incbib -sum NeuralOscillatorPaper.tex > wordcount.tex}


%For Supp. Numbering
\newcommand{\beginsupplement}{%
        \setcounter{table}{0}
        \renewcommand{\thetable}{S\arabic{table}}%
        \setcounter{figure}{0}
        \renewcommand{\thefigure}{S\arabic{figure}}%
     }


\newcommand{\Cov}{\mathrm{Cov}}
\newcommand{\Dros }{\emph{Drosophila }}

%Use the \todoXX where XX is your initials 
\newcommand{\todoKL}[1]{\todo[author=KL,color=blue!40, size=\tiny,inline]{#1}}
\newcommand{\todoAW}[1]{\todo[author=AW,color=green, size=\tiny,inline]{#1}}
\newcommand{\todoBW}[1]{\todo[author=BW,color=orange, size=\tiny,inline]{#1}}

\renewcommand{\vec}[1]{\boldsymbol{#1}}

%%Code location: The calculations were produced from the mathematica file Calculations/HeadModel.mb
%The pertubations used the function measurePertubationEffects in that file.

\author{Antoine Wystrach\textsuperscript{1†}, Konstantinos Lagogiannis\textsuperscript{1†*} and Barbara Webb.}


\title{Continuous lateral oscillations as a core mechanism for taxis in \Dros larvae}
%ex title{Taxis in \Dros larvae can be modelled as simple sensory modulation of lateral oscillation.}

\begin{document}
%\subsubsection*{Counts of words} 
%TC:ignore 
\linenumbers

\listoftodos
%TC:endignore 

\maketitle

%TC:break _ABSTRACT_
\begin{abstract}
The larvae of \Dros  Melanogaster spontaneously crawl towards or away from odours. This taxis behaviour is thought to consist of several distinct control mechanisms that trigger specific actions, sometimes characterised as decision-making based on short-term memory. The present work supports an alternative, simpler, hypothesis: that taxis results from direct ongoing sensory modulation of continuous lateral oscillations of the anterior body, with a linear gain. An analysis of larvae crawling shows a rythmical, continuous lateral oscillation of the anterior body which encompasses all head sweeps, small or large, without breaking the oscillatory rhythm. We demonstrate that an abstract model agent based on this principle, operating in closed loop with the sensory environment, reproduces a surprising number of phenomena observed in larvae. Crucially, it does not require the `steering signal' to be lateralised; instead the closed loop imposes the appropriate relations of sensory input to motor output. Moreover, this mechanism enables all sensory modalities guiding taxis, innate or learnt, to converge on a single motor control substrate. This provides a simple and robust solution to integrate multiple information sources, and accounts for recent data showing strong consistencies in the effects on taxis of changes in stimulus amplitude, learning, and multimodal stimulation. We also show, in a more realistic continuous time simulation, that the oscillatory mechanism has a plausible neural implementation, and discuss the relevant neural pathways in the larvae that could support the hypothesised modulation signal.
\end{abstract}

%TC:break _MAIN_
\section{Introduction}
The larvae of \Dros display taxis behaviours by spontaneously crawling towards or away from the source of stimuli such as odours, or more generally, up or down stimulus gradients, including chemical, light and temperature gradients \citep{luo2010navigational,gomez2011active,gomez2012active,gomez2014multilevel,kane2013sensorimotor,klein2015sensory}. This behavioural tendency is flexible and can be altered by associative learning if the stimulus is presented together with a positive or negative reinforcer \citep{ache2005olfaction,scherer2003olfactory,gerber2004engram,diegelmann2013maggot,schleyer2015learning}. The development of both a rich genetic manipulation toolkit and sophisticated behavioural assays, \citep{gerber2009smelling,diegelmann2013maggot} 
\todoBW{additional citations needed} 
have provided the basis for an explosion of studies targeting the biological underpinnings of larval taxis, as an ideal model system for investigating the neural basis of sensorimotor control and learning.

Larval chemotaxis in particular has been extensively studied. The main chemosensory organ is located on the head, and the small spatial separation of the bilateral olfactory receptors makes it unlikely that the animal can detect the instantaneous odour gradient. In fact, it has been shown that larvae can still chemotax with a single active receptor  \citep{fishilevich2005chemotaxis,gomez2010mechanisms,louis2008bilateral}. The key information used by the larva  appears to be the change in odour concentration experienced as it moves forward and/or casts its head sideways \citep{gomez2010mechanisms}. 
%\AW-----------woulddelete KL: tried to link it better here, think its still relevant to ground our selves well from the beginning around these transients that we keep refering to next/. True though Can be spared but the whole idea of transients is not as well founded then/and missing from our BG literature.
Olfactory sensory neurons are well suited to carry this information as they have been shown to give strong transient responses during changes in odour concentration \citep{de2013common,nagel2011biophysical,kim2011system,schulze2015dynamical} and the frequency and direction of turns (large body bends leading to a new trajectory direction) appears correlated to  decreases or increases in the perceived concentration \citep{hernandez2015reverse,schulze2015dynamical}. 
  Other sensory modalities could in principle use spatially separated sensors to detect instantaneous gradients across the body to direct steering, but recent studies reveal substantial similarity in the characteristics of larval taxis behaviour across different modalities \citep{gepner2015computations, bellmann2010optogenetically, lahiri2011two}. This suggests it may be possible to provide a more general account that elucidates the nature of the sensory-motor transformation during all forms of taxis, and how multiple stimuli combine. 

Several models have been designed to capture quantitatively the observed larval behaviour during approach to odour sources  \citep{davies2015model,hernandez2015reverse,schleyer2015learning,gepner2015computations}. These models typically assume the expression of taxis consists of multiple behavioural states with state transitions that are biased by sensory stimuli. In \cite{davies2015model}, a model closely based on the behavioural analyses in
 \citet{lahiri2011two,gomez2014multilevel,gomez2011active} reproduces many characteristics of larval chemotaxis by combining three mechanisms: biased forward runs (weathervaning), increased probability to stop runs when odour concentration decreases (klinokinesis), and increased probability to resume running when a head cast is in a direction that increases the experienced odour concentration (klinotaxis). Each contributes to improve odour taxis performance, and in theory each could be individually modulated by sensory stimuli characteristics, context, other stimuli, or learning, in manner that modifies the observed odour preferences. 
 % However, there is no clear behavioural evidence for independent modulation of different mechanisms under different circumstances.
%\todoBW{This statement makes me a bit nervous - are we sure there are no papers where e.g. run length changes while turning does not?} 
However, behavioural observation shows rather strong similarities in the behavioural modulations resulting from apparently unrelated conditions, such as odour-tastant associative learning and variation of stimulus concentration \citep{schleyer2015learning}, which simultaneously modulate both the klinokinetic and klinotactic response (weathervaning was not assessed in this study).

It remains possible that the apparent repertoire of taxis behaviours seen in the larvae is in fact the result of a single underlying mechanism. In this paper, we take a bottom up, synthetic approach \citep{braitenberg1986vehicles} to investigate whether a simpler sensorimotor control scheme can give rise to the observed phenomena of taxis. We combined a detailed observation of the larva crawling motions with an agent-based simulation to explore the behaviours that can emerge from the interaction between brain, body and environment.

%KL: Moved to Discussion:
%\todo{AW. would delete or keep for discussion} Closed loop sensory modulation of the dynamics of an intrinsic motor pattern can be a particularly efficient neural mechanism for flexible behavioural control \citep{lemon2015whole,izquierdo2010evolution,kanzaki1996behavioral,levi2005role,willis1997active}. 
%BW: I think we should leave this in the introduction. Otherwise we give the impression through the paper that the mechanism we suggest is a completely novel form of taxis, but in fact it has been previously suggested in several other systems. Mentioning this in the discussion is too late.
Specifically, inspired by the description in larvae of frequent low amplitude head casts that modulate run direction (Gomez Marin 2014), we tested whether continuous anterior body oscillation modulated by immediate sensory inputs would suffice for the emergence of taxis in a larva-like agent (c.f. the model for taxis in {\it C. elegans} proposed in \citet{izquierdo2010evolution}). Our analysis reveals that larvae indeed continuously display continuous anterior body oscillation, and that a simple discrete- time model based on this principle reproduces many specific larva taxis signatures, without requiring specific parameter tuning to different conditions. The hypothesis we put forward also naturally provides a simple and robust solution as to how to combine information across modalities, or from learnt and innate pathways. Finally, we demonstrate the biological relevance of our proposed mechanism by implementing its  core principles in a neural model that reproduces the same chemotaxis capabilities within a continuous-time framework.

\section{Results}
\subsection{Evidence for continuous anterior body oscillation in larvae}
 We used previously recorded tracks of 42 wild type larvae performing innate chemotaxis \citep{gomez2012active} to analyse the body-bend, the anterior body angular velocity and the forward speed. This reveals a continuous alternation between left and right turns (Figure \ref{fig:DynamicsExample}A ‘blue line’ angular velocity of the anterior part of the body). Larvae are known to regularly stop their forward peristalsis motion and display large lateral head sweeps \citep{gomez2011active}. A closer look shows that these head sweeps do not seem to break the continuous alternation between left and right turns, i.e., if the larva’s head was moving left before stopping the peristalsis motion, the first head sweep after stopping will be to the right, and vice versa (Figure \ref{fig:DynamicsExample}B). This suggests that these head sweeps are part of a continuous oscillation rather than individual motor actions triggered independently. Note also that body bending and anterior body angular velocity distributions show no signs of bimodality (Figure \ref{fig:DynamicsExample}E,F; \ref{fig:FigS2}) suggesting a continuous modulation rather than a discrete set of distinguishable actions. 

A Fourier analysis confirms the existence of an oscillatory rhythm with a mean frequency around 0.3Hz; that is roughly one turn left and one turn right every 3.3 seconds (Figure \ref{fig:DynamicsExample}D). This turning oscillation seems decoupled from the peristalsis motion (supplemental Figure \ref{fig:FigS2}), which operates around a mean frequency of 1.1 Hz (Figure \ref{fig:DynamicsExample}D, green).
\todoKL{point of coupling peristalsis to turn reads unclear/ consider rephrasing}
 A direct coupling between peristalsis and turning oscillation would force the larvae to spend exactly as much time turning left as right, so that turning modulation would be possible only by modulating the angular speed. By having them decoupled, the duration of the turns can also be modulated. When displaying a curving path to the left, larvae indeed spend more time (and also increase the angular speed) turning left than turning right (Figure \ref{fig:DynamicsExample}A ‘blue region’:  Time spent turning right = 12.9s; Time spent turning left = 22.9s; Ratio right/left= 0.64. Integral left =179.3 degrees; Integral right = -64.6 degrees; Total = 114.7 degrees left; Ratio right/left= 0.73).

To summarize, our observations support the hypothesis that a continuous lateral oscillation of the anterior body sits at the core of the chemotaxis mechanism and that its rhythm is decoupled to the peristaltic rhythm thus allowing more freedom to adjust the head-turning velocity and amplitude.


\subsection{A simple oscillatory agent reproduces taxis}
We embedded the hypothesis that continuous lateral oscillation of the anterior body sits at the core of the taxis mechanism in a simple agent-based model, which runs in discrete-time, and sought to establish the essential sensorimotor components that could underlie the emergence of chemotactic signatures. The model is based on the following simplifying assumptions:
\begin{itemize}
\item Stopping (inhibition of forward peristalsis) is not essential for taxis, it is viewed as the extrema in reducing the forward speed, allowing for increases in the range of body curvature. Therefore, stops play an auxiliary role either allowing to overcome physical constraints of the larval body or to modify the dynamics of the motor  system such that it can achieve larger body-bending. Hence we neglect peristalsis inhibition, and in our model, the agent is continuously making small steps forward, even when displaying large turns (note that we address the limits of this assumption further in the discussion).
\item Head bearing determines the direction on each time-step, and hence is the only crucial variable to model.
%KL Removed for terseness of list.(e.g., the ‘body angle’ between the anterior and posterior segments is not directly relevant, except in so far as it supports making lateral head movements).
 Therefore, we limit our model to anterior part of the body, which is abstracted to a point for the head position along with an orientation (Figure \ref{fig:MethodAgent}A). 
%KL: Premature detail We constrained turns (changes in bearing) to a maximum of 180 degree between two successive time-steps.
\item ‘Small amplitude head-casts’ and ‘large amplitude head-casts’ (Gomez Marin 2014) are manifestations of a single underlying mechanism that continuously drives a lateral oscillation of the anterior body.
 Crucially, this means the {\it direction} of a head-cast at a given time-step is determined only by the current state of an underlying oscillator and not due to its recent sensory history driving a voluntary movement towards moving or probing in a particular direction.
%KL:Removed this as out of context/not presented yet -In our discrete model, this oscillation is represented by having the head bearing altering to the right and left (i.e., by a + or – angle) on successive steps. 
\item The {\it amplitude} of each of these continuous head-casts is a function of the change in stimulus intensity perceived. % for a given state of the oscillator.
 The perceptual input (transient) is taken as the difference in the samples between two successive head locations within a stimulus gradient. This transient linearly determines the size of the change in bearing on the next time-step, which occurs on top of a baseline change that is driven by the continuous head oscillation (Figure \ref{fig:MethodAgent}B). Thus, the next bearing angle is bidirectionally modulated:
%\todoBW{bidirectional does not seem the right word here, I find it confusing. Is the point to make that the angle can be increased or decreased? Why not just say that?} KL: Laconism
%\todo{And not specify a negative gain relationship, as we immediately point out that can have positive gain to get aversion.} KL: The sign of the gain for attraction or aversion is only a preference of how you write the algorithm - and which ever convention only applies the discrete agent. So better not bind to the direction of the gain so much
an increase in the perceived transient on one step would lead to a decrease in turning away at the next step, while a decrease in the perceived transient will lead to an increase in turning away on the next step.
\end{itemize}

The above assumptions have been embedded into a discrete-time agent described in the Methods\ref{sec:methodsDiscreteAgent}). Figure \ref{fig:MethodAgent}C shows that this rather simple agent is sufficient to produce attraction or repulsion
% KL Done\todoBW{BW:In fig 1 label says repulsion, should make these consistent}
 to a sensory source when placed in a gradient.  The behaviour is very robust to choice of baseline or gain values (supplementary Figure \ref{fig:FigS1}). In the following sections, we examine in detail how well this basic model actually captures the typical chemotactic signatures observed in larvae, including path shapes, bearing to odour distribution shapes, sensory history, and their qualitative change resulting from typical manipulations such as change in stimulus concentration, associative learning or presence of tastants.


\subsection{Characteristic taxis trajectories}
 %: orbital and segmented search
An emergent property of our agent model is that the distribution of bearing angle to the odour's source shows two peaks around 90 and -90 degrees (Figure \ref{fig:PathSignatures}). Therefore, the agent tends to spend more time with the odour on its sides rather than directly in front or behind it. Interestingly, this seems to be also the case with real larvae (Figure \ref{fig:PathSignatures}). For both  larval and the agent generated paths, this tendency is emphasised while displaying small turns (Figure \ref{fig:PathSignatures}C blue line) whereas large turns tend to happen while the odour is located behind (Figure \ref{fig:PathSignatures}C red line). Spending time with the odour located 90 degrees on the side translates into orbiting around the odour source. This ‘orbital behaviour’ can be observed clearly in simulations results from the deterministic (absence of random noise) version of our agent model (Figures \ref{fig:PathSignatures}B and \ref{fig:OSN}B).

%%%%%\todoKL: Removed explanation, if we don't aim to analyse the agent/algorithm in this paper then we shouldn't need to explain why orbits arise in the results section.
%%%%%%The orbital behaviour in our model can be directly understood by noting the equivalence of our agent's algorithm to a line-search algorithm that is attempting to track the orientation of a peak (e.g., the point of maximum concentration) by successive left and right reorientations (see Figure \ref{fig:AlgoAnalysis}, supplementary material 1). In the absence of forward movement, re-orientation in the direction of the peak would converge incrementally until left and right positions fall on either side of the peak. However, as the agent is not stationary, every step taken that is not headed exactly towards the peak will cause the direction of the peak, relative to the agent, to shift. The speed of this apparent peak shift, for a fixed step size, increases as the agent gets closer to the source. Orbits thus arises when the speed of the shifting peak matches the agent's reorientation speed. Reorientation speed depends on the agent's sensory transient to turn modulation gain, so that the higher the gain, the closer to the source the orbit will be. If the reorientation speed is sufficient to exceed the apparent peak shift across all possible larval bearings to odour angles, then the agent's trajectory shape changes and is characterized by straight crossings over the odour source, and sharp re-orientation events once the peak has been passed over (Figure \ref{fig:PathSignatures}B). Examination of actual larvae paths suggests that larvae possess a transient-to-turn modulation gain high enough for such crossing-over trajectories to emerge when close to the odour source (Figure \ref{fig:PathSignatures}A, D); except for the Or42a single receptor mutant larvae, which show an orbital behaviour (see below). As a result the model predicts different statistics depending on the proximity to the odour: when crossing-over paths occur, this results in a flattening of the bearing-to-odour distribution curve; which we indeed observe also in real larvae (Figure \ref{fig:PathSignatures}D).
%%%%

However, increasing the gain results in a qualitative change to the shape  of agent's trajectories from circular orbits to those characterized by straight crossings over the odour source, and sharp re-orientation events once the peak has been passed over (Figure \ref{fig:PathSignatures}B). Examination of actual larvae paths suggests that larvae possess a transient-to-turn modulation gain high enough for such crossing-over trajectories to emerge when close to the odour source (Figure \ref{fig:PathSignatures}A, D); except for the Or42a single receptor mutant larvae, which show an orbital behaviour (see below). As a result the model predicts different statistics depending on the proximity to the odour: when crossing-over paths occur, this results in a flattening of the bearing-to-odour distribution curve; which we indeed observe also in real larvae (Figure \ref{fig:PathSignatures}D).



\subsection{Or42A mutant behavioural signatures as simple change in gain}
In \cite{gomez2011active}, larvae with genetically modified peripheral olfactory circuits were shown to display different chemotactic signatures to wild-type larvae.
 Larvae that had the Or42a olfactory receptor ectopically expressed in the 21 intact ORNs appeared to conduct a rather less concentrated search near the odour source; larvae with only a single-functional pair of ORN active displayed an orbital behaviour, while anosmic larvae displayed what can be described as a random-search path (Figure \ref{fig:OSN}A).
 These different chemotactic signatures can be reproduced by our model by simply lowering the transient-to-turn modulation gain 
%\todo{In the next section we make a point of saying concentration changes the input signal, and learning the gain, with equivalent effects because of the linearity. Should we not introduce that point explicitly here?}
 (Figure \ref{fig:OSN}B).
 Due to the assumption that the mapping of the stimulus to the next turn angle is linear, the operations of  scaling the stimulus gradient perceived or the modifying the transient-to-turn gain are equivalent.
  Physiologically the gain can be reduced by reducing the number of receptors, for example we might expect that the presence of only a single-functional pair of Or42a will result in lowering the stimulus perceived.
 Similarly, even when the same Or42a is expressed ectopically in the 21 intact ORNs, it may be the case that this modified overall receptor ensemble is still less effective than the variety of ORs expressed in the wild-type because the olfactory system in the case is not as responsive over the whole concentration range of a gradient. Indeed, there is evidence from behavioural and physiological responses to suggest that at least two receptors with different concentration thresholds can be found to be sensitive to a particular odourant \citep{kreher2008translation}. 
Accordingly, larva expressing only a high-affinity receptor have been observed to draw large curved paths around a source, a behaviour that has been previously described as a switch from attraction to aversion as mutant larvae approach the odour source \citep{gomez2011active, kreher2008translation}. %%Also check khurana2013olfactory
%%There is evidence from behavioural and physiological responses to support that at least two receptors with different concentration thresholds can be found to be sensitive to a particular odourant \citep{kreher2008translation}. Interestingly the behavioural responses in mutants missing the high-concentration tuned OR appear to turn into repulsion \citep{kreher2008translation,gomez2011active} 
  Reproducing this behaviour in our agent simply requires us to assume the mutant's operational ORNs saturate as close to the odour source. ORNs operating close to saturation will generally give weaker sensory transient responses that translate into a gain reduction, which has been shown to produce orbiting paths. This behaviour would appear as though the agent has an aversion to higher concentrations if the orbit radius is prominently large.
 
 Overall the model is consistent with the finding that ``the summed response of the entire receptor repertoire correlates with the strength of the behavioural response.” \citep{kreher2008translation}. Increasing the number of available receptors results in an overall increase in the input, which in our model is equivalent to increasing the gain. The result is also consistent with the observation that, although bilateral olfactory input is not necessary, it appears to enhances larval chemotaxis \citep{louis2008bilateral}.


\subsection{Similar effects of odour concentration and learning}
The effect of changing the concentration of an odour source on the group statistics of innate larval chemotaxis has been reported in \citep{schleyer2015learning}. Specifically, they recorded turn rate and turn direction given the current bearing to odour (their Figures 3 and 4, redrawn in Figure \ref{fig:Concentration}A,C). For an attractive odour (n-amyl-acetate) turns occur more frequently when facing away from the odour and less frequently when facing towards it; and turning direction is more frequent to the side that the odour is on (originally shown in \citet{gomez2011active}). These phenomena were modulated by changing the concentration of the odour, with the effect of bearing angle on both turn rate and turn direction becoming more pronounced, and the approach to odour consequently more rapid, with increasing concentration.

The same \cite{schleyer2015learning} study revealed that associative learning leads to the same modulation of chemotactic statistics as seen for concentration changes \citep[][Figures 3 and 4]{schleyer2015learning}. After appetitive learning (by pairing presentation of an odour with fructose reward) turns occur more often when facing away from the odour and less often when heading toward the odour; and turning direction is biased more strongly toward the odour source. The opposite is true for the ‘unpaired’ group for which the odour was presented when the reward was removed. 


 To compare these statistics to our simulation we approximated their definition of ‘turns’ (resuming motion on a significantly altered trajectory after stopping and casting) by selecting large turns ($>30$ degrees) that are not followed immediately by another large turn. The relevant bearing angle for a turn is taken to be the head direction relative to the odour source on the previous time-step (before the large head sweep). We find the same pattern of turn rate and turn direction relative to bearing (Figure \ref{fig:Concentration}B,D).

The effect of changing concentration can be modelled simply by assuming that higher concentration leads to a stronger transient being perceived. This may result from steeper gradient of concentration, or, as for the Or42a results above, by assuming that higher concentrations yield stronger signals.  “Several studies have found that higher odour concentrations activate more neurons than lower concentrations, [...] at higher concentrations, many odorants activate multiple receptors, while at lower concentrations, many odorants activate fewer receptors” \citep{hallem2006coding}.
 As a result, changing the concentration yields similar modulations of the turn rate and turn direction distributions (Figure \ref{fig:Concentration})

Similarly, the effects of learning can be captured by our model given the assumption that appetitive learning increases the transient-to-turn gain, and unpaired learning decreases it towards zero. Potentially, the change in gain could cross zero and change sign, therefore switching the behaviour from attraction to aversion. However, since the net gain is determined by the superposition of multiple inputs, a sign change could simply result from a shift in the balance between the summed excitatory vs. the inhibitory signals. Again the model can reproduce the effects observed in larvae (Figure \ref{fig:Concentration}). 

Note that the equivalence in behavioural changes to concentration and learning in larvae is thus explained as a simple consequence of the linearity of the sensorimotor modulation in our model. A transient perceived twice as strong (due to a more concentrated odour source) has the same effect on turning as a transient-to-turn modulation gain that is twice as strong (due to appetitive learning), hence producing similar outcomes. We thus predict that the motor effects of learning and odour concentration can sum up, leading to increased attraction (e.g., darkest red curve in concentration) insofar as the odour is still recognised by the larvae. It should be noted however that increasing the odour concentration is likely to alter the overall shape of the distribution of odour concentration, and thus yield different trajectory shapes than learning would.


If learning is indeed reified as a simple change in gain, this could be either a under a multiplicative scaling of innate gain, or an additive signal by which the learning pathway contributes to the innate gain. In our model we take learning to express an additive change in gain that could be either inhibitory or excitatory with the potential of changing attraction to aversion.
%KL:Not sure on this argument - it is not even justified by anything or reference, better remove: A modulatory effect could only reduce the gain to zero, not change its sign.
%Removed, looks like something for a discussion section - and cutting helps shorten the paper.  On the other hand, if the behaviour depends on a balance between innate attraction and aversion (contributing negative and postive gain respectively) then modulation of one contribution could result in the expression of the other. We discuss this in relation to possible neural pathways in the discussion.

\subsection{Learning and preference index}
Learning effects in larvae are more commonly assessed by calculating a preference index (PI) resulting from mass assays \citep{gerber2009smelling}. The PI is calculated by allowing up to 30 larvae to chemotax for a few minutes, and counting the proportion of larvae that end up on the side of the dish containing the odour that has been paired (or unpaired) with reward. If we run the same mass assays on our simulation, it is clear that the hypothesised effect of learning on the gain results in modulating the efficacy of taxis, leading to group level preference indexes similar to those observed with real larvae (Figure \ref{fig:PreferenceIndex}A). Note that the PI (as calculated by the ratio of 30 simulated larvae ending up on the odour side/other side after 3 minutes) varies quite linearly with the transient-to-turn modulation gain, roughly doubling when the gain doubles (Figure \ref{fig:PreferenceIndex}A).
 This relationship is robust to additive noise (Figure \ref{fig:PreferenceIndex}C), which was modelled by drawing from a normal distribution, transforming this to an angle, and adding it to the intended turning angle on each time-step.
  Even for very high noise levels, a clear performance index change in relation to changing gain is observed. These results together suggest that while it might be difficult to observe the effects of learning in individual larval actions (as they may be swamped by noise), it may nevertheless be possible to find the neural correlate of the substantial change in gain needed to produce a significant change in PI.
Note that this contrasts with results from a previous `state transition' model of chemotaxis \citep{davies2015model} where very small changes in the biases in state transitions had a strong non-linear impact on the PI, making it hard to reconcile the available data from individual tracking and mass assays.

\subsection{Effect of the presence of fructose}
\cite{schleyer2015learning} describe a particular effect of the presence of fructose during chemotaxis: it increases the overall turn rate, independently of the current bearing to the odour Figure \ref{fig:Tonic}A). To capture this effect, our model simply requires that fructose receptors provide a tonic input to the oscillator, i.e., modulating the size of the next head cast relative to the current stimulus intensity, rather than the phasic input (modulation proportional to change in stimulus intensity) we have assumed thus far. In this experimental situation, the fructose concentration is constant across the dish, so the effect is a constant increase that does not vary with the bearing to odour. For our model (see methods) such a tonic signal is equivalent to changing the baseline input $T_b$, hence the baseline size of turn, $\Theta_b$, and thus the probability to display large turns. 

When released in a petri-dish with one half filled with pure agarose and the other half filled with agarose and fructose, more larvae are observed on the fructose side after a couple of minutes \citep{schleyer2011behavior}. A tonic effect of fructose could, in theory, mediate this gustatory preference, as increasing the overall turn rate might be expected to increase the time spent in the area of fructose. However, if we use the small tonic increase in turn rate that was observed in larvae, and test the behaviour of our agent under the same conditions, no significant gustatory index emerges within the 3 min of test (Figure \ref{fig:Tonic}B).

 To reproduce a significant tendency to stay on the fructose side, we needed to introduce a phasic response to fructose, with a negative gain, which would lead the agent to react immediately to the sharp transition at the boundary; turning back when leaving the fructose area, or continuing straight when entering the area (Figure \ref{fig:Tonic}C,D). The simultaneous presence of a tonic effect helps, but is not crucial to observe a significant gustatory index (Figure \ref{fig:Tonic}B).

  Conversely, avoidance of repulsive tastants such as quinine or high concentrations of salt \citep{schleyer2011behavior} can be modelled using a phasic connection with positive gain (Figure \ref{fig:Tonic}B). We note here that many sensory neurons responses show both phasic and tonic components, and will return to this point in the discussion.

\subsection{Sensory history preceding turns}
The average sensory history perceived before the occurrence of large turns shows a slow monotonic decrease in concentration which extends up to 10s prior to the large turn. This has been reported for larvae  \citep{gomez2011active} but can also be observed in our model (Figure \ref{fig:SensoryHistory}). In larvae, this may suggest the existence of a low-pass filter enabling larvae to integrate monotonic decreases over relatively long time scales to increase the probability of triggering a large turn \citep{gomez2011active,davies2015model}. However, our model does not possess such a low-pass filter: large turns occur as the consequence of the transient experienced during the last step only.
 In our model, the reason for this monotonic decrease over a much longer time scale is that a high turn is more likely to be triggered when the larvae is facing away from the odour at t=0 (hence experiences a strongly negative transient); and facing away from the odour a t=0 means a high likelihood of facing away from the odour (or at least not towards it) at t=-1; and thus also, but slightly less likely, at t=-2; etc. The emergence of this effect from the interaction of the reactive model with the environment suggests caution is needed when interpreting the causal implications of sensory history prior to actions.
\todoBW{Should we also discuss the Hernandez-Nunez reverse correlation results here? May be relevant that using white-noise stimuli, they get a shorter (around 2 second) decrease as the transition to turn trigger} 

\subsection{First-turn bias}
Larvae show a slight tendency to bias their first head cast after stopping peristalsis towards the side of the attractive stimulus (i.e. the odour side \citep{gomez2011active,gomez2012active} or darker side during negative phototaxis \citep{kane2013sensorimotor}, or towards preferred temperatures \citep{luo2010navigational}. This may suggest the involvement of bilateral sensing to obtain gradient information, or a memory of gradient information obtained during the run. But if we identify ‘turns’ in our model as those head cast angles exceeding the threshold that is usually associated with stopping in the larva, the agent also reveals a tendency to bias its first turns towards the odour source (Figure \ref{fig:FirstTurn}), despite having no gradient information other than the change from one time step to the next. This tendency arises because of the oscillatory nature of the agent: large turns are more likely to be triggered when a negative transient has been perceived during the previous step; negative transients are more likely to be perceived when turning away from the odour; thus subsequent turns in the opposite direction, following a negative transient, is more likely to be directed towards the odour. 

Nonetheless this bias is weak and requires a large data set to appear significant. Our model predicts that the bias should  increases with odour attraction, whether from stronger gain due to appetitive learning; stronger sensory input due to increased odour concentration, or both (Figure \ref{fig:FirstTurn}A), and becomes more apparent when the odour is located on one side of the larvae (Figure \ref{fig:FirstTurn}B).

\subsection{A neural implementation of oscillation}
So far, we have used a simple discrete time model to examine whether the basic principle of alternating head casts, modulated in amplitude by sensory transients, can account for larval chemotaxis. A crucial consequence, if this model is correct, is that the descending signal that controls directed behaviour in the animal does not need to be lateralised, e.g, there does not need to be a stronger signal to the side of the body closer to the stimulus source. Directional bias emerges because the change in concentration observed on one head cast determines the extent of the next headcast. In our discrete model this effect is precise, which might imply that the descending signal in the larvae requires equal precision in the timing with which it interacts with the ongoing motor control of the oscillation. Here, as a proof of concept, we consider a more realistic biophysical model for oscillation operating in continuous time, and examine whether, in theory, a single bilateral descending signal representing the sensory transient can smoothly interact with ongoing oscillation to produce taxis.

The model is based on coupled neural oscillators, following the well established principle that the main drivers of rhythmic  motor sequences, underlying key behaviours such as locomotion, circulation, respiration and feeding are neural systems operating as central pattern generators (CPGs) \citep{delcomyn1980neural}. A CPG is believed to operate  within the thoracic and abdominal segments of larvae, executing a motor program for exploratory locomotion \citep{hughes2007sensory,berni2012autonomous,lemon2015whole}, although the details of the underlying circuitry are unknown. We therefore adapt (see methods \ref{sec:methodsCoupledOscillator}) a spike-rate neural model of coupled CPGs that has been successfully used to model lamprey locomotion \citep{cohen1992modelling,lansner1997realistic}, \cite[see][]{marder1996principles}.


The oscillator consists of a pair of compartments, taken to be producing the premotor activity of the left and right bend muscles of the larval thoracic  segments respectively (Figure \ref{fig:LampreyModel}A). Each compartment has a pool of self-connected excitatory neurons (E), and a cross-inhibitory interneuron (C) projecting to the other compartment. This connectivity produces regular alternation in firing bursts between left and right sides that can be modified by the additional bilateral inputs, $A$ and $S$. The $A$ unit represent descending sensory transient signals either processed or direct while the $S$ unit represents a modulatory neurons.
 The spike rate in the two compartments is then related to head angular velocity via a simple mechanical model (\ref{fig:LampreyModel}.B, see methods). As in the discrete model this agent also ignores stops, it moves forward at a constant speed in the direction of the head angle. Further, in the absence of stimuli arriving from the input unit $A$, this system produces a regular $\pm 10$ degrees oscillation of the head at around 0.3Hz. However, the input allows this oscillation to be perturbed, modifying  the amplitude and phase relationships between the bursts of each side. Such perturbations produce a change in the agents heading, because .

%\todo{AW.can be reshaped so as to avoid repeating the figure legend and what we did; just the results?}
Initially, we evaluated the ability of the continuous larva agent model to express overall bearing changes in response to perturbations to the input $A$ (note both sides $L$ and $R$ receive the same perturbation) at different points in the oscillation cycle. Measuring the overall change in bearing against a bilateral step input of magnitude $A_m$ across different times $t_s$ showed that the larva can be steered in a direction determined by the sign of $A_m$ and its broad timing in relation to the head orientation.
%\todoBW{I think you need to say how - by the sign of $A_m$?}
Notably, the change in bearing is not critically dependent on the timing of the perturbation. 

% An example of the oscillator activity and the stimulus used is shown at the bottom inset of \ref{fig:LampreyModel}.F (note for clarity the effect of the stimulus on the burst pattern is not shown), and the resulting angular velocity and bearing of the head shown in the central graph. \ref{fig:LampreyModel}.F (top) shows the effect on the bearing of the larva under step perturbations to the input $A$ as the timing of the onset $t_s$ of the perturbations is varied across the phase (see Methods). The change in bearing appears as a sinusoid against the timing of the onset of either a positive or negative step. \todo{need to explain better what this means}. The magnitude of the sinusoid is modulated by the size of the step $A_m$. Changing the sign of $A_m$ changes the direction of turning. 

We then examined the ability of the model to chemotax in a virtual odour environment. We show that the continuous agent also produces curved paths when further away from the odour source, characteristic of larval weathervaning behaviour, that subsequently become orbits around the odour source (Figure \ref{fig:LampreyModel}D). The parameters of the model have been set such that the frequency of oscillation is within the ranges observed in larva (see \ref{fig:LampreyModel}C), and thus when measuring the mean frequency of head oscillation over such trajectories we obtain a noisy frequency spectrum comparable to the larval trajectory data. Further we established that a doubling of the gain (from $G=70$ to $G=140$), which effectively doubles the input due to the sensory induced perturbations from the input $A$, results in a qualitatively comparable change to crossing-over trajectories, which we have also previously obtained with the discrete agent. The anterior body angular velocity dynamic emerging from the model (Figure \ref{fig:LampreyModel}.E) is reminiscent of that observed in the experimental data (Figure \ref{fig:DynamicsExample}).
Since the activity of each oscillator drives the respective muscle that controls head turning, the sensory stimuli during a head turn naturally falls into a fixed phase relationship to the oscillator activity. Therefore, the input perturbation perceived in the virtual odour environment relates to the head motion as these two variables are in a closed-loop. 
Consequently, increasing the gain also increases head speed and thus results in sharper re-orientation manoeuvres, which in turn results in larger sensory perturbations.
 
This agent model therefore demonstrated that sensory transient signals can  directly modulated a pre-motor circuit activity. It is plausible that such a CPG circuit resides in the segments of the larval VNC \citep{kohsaka2012development}, with modulatory neurons being an integral part in generating locomotive patterns \citep{suster2003targeted}. When coupled to drive a simple biomechanical model of the larval body, the directed motor behaviour produced resembled the one displayed during larval chemotaxis.




\section{Discussion}
We have used an agent based simulation to investigate how taxis behaviours in \Dros larvae can result from the interaction of brain, behaviour and the environment. 
% BW: I don't find this sentence clear or necessary
% We believe our model captures the essential mechanisms for the emergence of behavioural signatures characteristic of taxis and unifies previously identified frequent ‘low amplitude head-casts’ \citep{gomez2014multilevel} with the apparent continuous oscillation of the anterior body (Figure \ref{fig:DynamicsExample}). %Is *turning velocity* required here? 
 The model consists of a sensory process sensitive to changes in stimulus conditions that modulates the amplitude of an ongoing oscillation of the anterior body that carries this sensor.
These two components are coupled by a simple linear gain and operate in a closed-loop with the environment to produce robust taxis (Figure \ref{fig:MethodAgent} and supplementary material). We can generate a range of phenomena observed in larvae (see results) through simple variation of this gain.
% BW: see my earlier comment for why I think the next sentence belongs in the introduction.
%KL:It was moved here from Intro  hmm lets leave it here for now 
%BW: okay, I've put a mention in the intro for C.elegans.
We therefore suggest that larval taxis results from a closed-loop sensory modulation of the dynamics of an intrinsic motor pattern, which can be a particularly efficient neural mechanism for flexible behavioural control \citep{lemon2015whole,izquierdo2010evolution,kanzaki1996behavioral,levi2005role,willis1997active}. 

 We here discuss the key conceptual elements of the model, their potential relationship to the underlying neural circuitry, and some predictions that emerge for future investigation.


\subsection{Oscillation as a principle of larval locomotion}
%KLDone\todoBW{cites in this paragraph and next need to be changed to bibtex}
Larvae are known to display several typical behavioural features during chemotaxis \citep{green1983organization,cobbwhatandhow1999,gomez2012active}.
 They can show straight runs or curved runs mediated by small amplitude head-casts (i.e. the so-called weathervaning \citep{iino2009parallel,ohashi2014novel,gomez2014multilevel}, stop the crawling forward motion and display large head-casts, and resume forward motion in a new direction (i.e. so-called ‘turns’).
 Our model assumes that underlying these features there is a regular and continuous left-right oscillation of the anterior body, and we have presented evidence from larval tracking that such a rhythmic oscillation exists, apparently uncorrelated with the peristaltic rhythm (Figure \ref{fig:FigS2}, Figure \ref{fig:DynamicsExample}  ).
 Rhythmic behaviour is ubiquitous in biological systems. In some animals, such as {\it C. Elegans} \citep{iino2009parallel,izquierdo2010evolution,lockery2011computational}  or the lamprey  \citep{lansner1997realistic,wilson1999spikes} producing anterior segments oscillations is necessary for forward locomotion because it relies on lateral undulations.
 In single amoeba cells \citep{yangzigzag2011}, as in many insects, oscillation about a heading direction can be observed even when direct forward motion is possible, and may have advantages for sensorimotor control when tracking up an odour trail \citep{hangartner1969structure} \todoKL{not clear to me how hangartner1969structure links to oscillations in the path. Are sure about this ref?}
  or plume \citep{budick2006free,belanger1996centrally,willis1997centrally,willis2008effects,carde2008navigational}  , when following a route \citep{lent2010image,kodzhabashev2015route}, or when approaching a visual target \citep{wallace1962experiments,philippides2013bumblebee,voss1998active}.

We take this continuous oscillation to be the underlying basis for behaviours of the larva that are often treated as distinct states resulting from dedicated sensory motor processes (check \cite{vogelstein2014discovery, green1983organization, cobbwhatandhow1999, gomez2012active, gomez2014multilevel, hernandez2015reverse,gepner2015computations}).
 That is, we suggest running/weathervaning and casting/turning all result from the same underlying and continuously active oscillatory mechanism (Figure \ref{fig:Peristalsis}C,D).
  Hence we would predict that it should not be possible to isolate distinct control circuits for these behaviours: for example, genetically switching-off weathervaning without affecting high amplitude head-casts or vice-versa, as body-bending modulation is always under the control of the same oscillator. 

In this oscillatory taxis mechanism ‘directed’ motion by the animal towards a target does not require a lateralised descending signal. Sensory information does not need to be segregated between left and right commands, nor does the agent need to know if it is currently moving left or right. The ‘decision’ to turn left or right simply emerges from the interaction of the non-directional sensory signal with the current state of the oscillator. 
One interesting corollary of this lack of internal representation of left and right motion is the prediction that an operant conditioning protocol that punished or rewarded re-orientation towards one side of the animal would not work.

As a proof of concept, we have presented a possible neural implementation of the hypothesised oscillator, based on a lamprey CPG model (Figure \ref{fig:LampreyModel}).
 This model also reproduces taxis signatures and notably, similar variations in the duration as well as the amplitude of the larvae head-swings (compare Figure \ref{fig:DynamicsExample}A-C and \ref{fig:LampreyModel}E).
  We do not believe that the lamprey CPG is necessarily representative of the larva oscillator, but the study of such dynamics may provide insight into its nature.
  We are not aware of any direct evidence for a similar circuit in the larva, but several aspects of the neuroanatomy of the ventral nerve cord are suggestive. Similar cross-connections are present in larvae all along the body \citep{rickert2011morphological}
%KL: Located rickert2011morphological refereing to 270 interneurons per seg and their corss connection patterns \todoBW{[additional references for existence of cross connection and other relevant motor circuit data]},
  but only the cross-connections located in the anterior segments of the ventral nerve cord (VNC)(T1 T2 T3) seem important for initiating turning \citep{ berni2015genetic}, which is consistent with our model. Interestingly, these segments seem to be selectively targeted by multiple inputs connecting to both sides of the body, which may represent the non-lateralised commands modulating turning. Genetic disruption of the normal midline connection pattern showed that larva can still inhibit peristalsis (see discussion below) but seem unable to turn left or right and appear instead to contract both sides simultaneously \citep{berni2015genetic}, which is consistent with the idea that turns are part of an intrinsic oscillator rhythm that is modulated by the sensory inputs bilaterally.

\subsection{Simple sensorimotor mapping}
%Inhibition and Excitation for attraction and repulsion.
We propose that the key mapping underlying taxis behaviour is a direct relationship of the perceived sensory transient to the modulation of oscillation amplitude.
Both the valence (attractive or aversive) and salience (strength of attraction or aversion) of stimuli is determined simply by the value of the effective gain by which the perceived stimulus transient modulates the amplitude of turning oscillations. For instance in our abstract model, a high negative gain leads our agent to display a strong attraction, whereas, a low but positive gain will lead to a moderate aversion (Figure \ref{fig:PreferenceIndex}). This is corroborated by evidence showing that antennal lobe (AL) glomeruli whose activity correlates with innate odour attraction send inhibitory projection (iPN) towards the lateral horn (LH); while glomeruli whose activity correlates with odour aversion send excitatory projections (ePN) (ref). 

 \cite{izquierdo2010evolution} proposed a similar mechanism to explain taxis behaviour in {\it C.Elegans}, i.e. intrinsic oscillation modulated by a bilateral signal proportional to change in sensory input. In their model, oscillations are regulated by both so-called ON and OFF cells. ON cells respond to up-gradient and down-regulate turns; and OFF cells detect down-gradient and up regulate turns, thus mediating attraction. In the larva, up and down-regulation of the turns could be mediated by a same sensory neuron being depolarised or hyperpolarised. This is in accordance with the fact that there is usually a single PN for each glomerulus in \Dros \citep{ramaekers2005glomerular} %KLDone \todoAW{(ref)}
 , and explains how PNs with opposite valence can cancel each other into a neutral behavioural response (see supplemental material). 
  
\subsection{Phasic and tonic connections}
Our model assumes that larvae are able to obtain the relative change in odour concentration perceived along the displacement of the head.  Electrophysiological recordings in larvae suggest that olfactory sensory neurons (OSNs) \citep{nagel2011biophysical,schulze2015dynamical} and projection neurons (PNs) do emphasize such transient information: when stimulated by step odour input, they show a sharp peak of activation at the onset of the stimulus, and a depolarisation at the offset \citep{schulze2015dynamical}. As noted for {\it C.Elegans} \citep{lockery2011computational}, such transient information is crucial to enable the agent to climb or escape gradient of stimulus concentration. 

Although not the main focus of this paper, we have also considered the effects of a tonic sensory response. Contrary to a phasic neuron, a tonic neuron response does not adapt and thus provokes in our model a consistent change in the larvae behaviour as long as it is exposed to the stimulus. The presence of a tonic excitatory response explains the overall increase of turns observed in larvae in the presence of fructose (Figure \ref{fig:Tonic}). Conversely, it could be supposed that aversive tastant such as quinine would decrease the rate of turns and thus straighten the path taken by the larvae by making a tonic inhibitory contribution to the overall gain. 

In theory, this illustrates well how two functionally different types of behavioural responses can simply result from the phasic/tonic nature of the signal. Any stimulus could send either or both types of information, and thus elicit either or both types of response. In practice, neurons show complex adaptation responses and the difference between tonic and phasic responses may not be clear-cut. For instance, OSNs seem to not fully adapt to strong artificial step stimuli \citep{nagel2011biophysical, schulze2015dynamical} and thus may also mediate a different tonic signal across different background intensities. Conversely, tonic neurons showing nonetheless a quick enough response to stimulus intensity variation may also convey transient information, and thus lead the agent to climb or descent gradient of stimulus intensity. However, the transient response of such a tonic neuron would operate only across a short range of stimulus background intensity due to firing rate saturation. How specific is the phasic/tonic nature of neurons in larvae along the different pathways would constitute an interesting research agenda.

\subsection{Combining sensory inputs}
Our model proposes a simple solution for how multiple sensory inputs could be combined: simply sum the inputs from the respective sensory receptors (Figure \ref{fig:Peristalsis}C). For instance, a stimulus perceived by two receptors with respective gains of -1 and -2; will result in an overall effective gain of -3, that is, will trigger a stronger attraction than with any receptor alone. Two receptors with exact opposite gain would cancel each other, and lead the agent to ignore the stimulus. This property captures well the evidence that the summed response of the entire olfactory receptor array – taking into account the valence of each receptor – correlates with the strength of the behavioural response (Kreher, et al. 2008 Neuron 59.1); as well as the idea that gradual inhibition within the antennal lobe mediates habituation \citep{das2011plasticity} which would correspond to the gain slowly tending towards zero in our model. 

Multiple modalities can be combined as easily, each influencing the taxis behaviour to the extent of their relative contribution to the effective gain (Figure \ref{fig:Peristalsis}C). This is consistent with the apparent similarity of taxis behaviours observed across modalities (compare for odour: \citep{gomez2011active}; light: \cite{kane2013sensorimotor},   Temperature: \cite{lahiri2011two}) and the fact that aversion to light and attraction to an odour can cancel out so smoothly \cite{bellmann2010optogenetically}. 

The subesophaegal zone could be a potential candidate as a zone of convergence before the integrated signal is sent downstream to the motor circuitry \cite{tastekin2015role}. The attractiveness of an odour should thus depend on the net weight of its output signal at this zone of convergence.  


\subsection{Integrating learning and motivation}
We can also model changes in behaviour observed in learning as a change of gain. We propose the output of the Mushroom body pathway \citep{gerber2004engram} can simply be viewed as an additional signal which also combines additively with the other pathways and thus participates to the overall gain (Figure \ref{fig:Peristalsis}C ). Thus the mushroom body can be thought of as a relay that modulates the valence and amplitude of its output signal to a specific pattern of input activation depending on the co-occurrence of appetitive or aversive reinforcers. The modulation of the signal can be achieved by adding new inhibitory or excitatory output connections or by changing the synaptic strength of pre-existing connections \citep{aso2014neuronal}. In either case, in our model the MB output signal is then combined with the signal of the innate pathways, participating to the overall gain and thus modifying the attraction or aversion behaviour to the trained odour (Ref). Note that in principle, any modality could avail itself of the mushroom body learning pathway, a dedicated innate pathway, or both (Figure \ref{fig:Peristalsis}C). 

If this is hypothesis about the contribution of the learning pathway to changing innate behaviour is correct, i.e., that both signals simply sum up at their zone of convergence (Figure \ref{fig:Peristalsis}C), then the information about the transient concentration experienced between successive steps is needs to be preserved by the PNs, Kenyon Cells (KCs) and mushroom body output neurons (MBONs). Moreover, the MB pathway should be able to mediate an appropriate behavioural response independently of the innate pathway. This possibility is supported by the fact that artificial thermogenetic activation of ensembles of KCs can directly modulate temperature preference behaviour in adult flies \citep{vasmer2014induction}. 

%DoneK\todoBW{cites in this paragraph (and above?) need to be changed to bibtex}
Although not included in the current model, developmental \citep{gong2010two,wu2003developmental} and motivational \citep{krashes2009neural} %and contextual  \todo{ref?(Gerber review?)}
 effects could also be integrated by simply potentiating or inhibiting connections from specific stimuli. For instance, dNPF neurons, which encode satiety levels, could modulate the behavioural expression of innate or food-associated memory \citep{krashes2009neural}  by modulating the gain of these respective connections. Similarly, the current presence of sugar in the environment could simply inhibit the MBON connection mediating the behavioural expression of the odour-associated memory \citep{schleyer2011behavior}.

\subsection{Integrating lateral oscillation with peristaltic motion}
By ignoring the peristalsis inhibition events observed in larvae, our models showed that peristalsis inhibition is not crucial for the emergence of the taxis signatures discussed above. However, it is clear that crawling speed can vary in larvae, besides the sharp decrease towards zero speed correlated with the larger body bends (Figure \ref{fig:DynamicsExample} tail speed). How is crawling speed controlled? It could be that physical constraints lead to the peristaltic wave being disrupted by large turns, and indeed most higher amplitude turns are achieved when the peristalsis is indeed inhibited (Figure \ref{fig:DynamicsExample}E, F; \ref{fig:FigS3}). However, our analysis (consistent with \citet{hernandez2015reverse}) shows that the inhibition of the forward motion is triggered on average at the onset of the turn and is thus clearly not a mere consequence of large body bends (Figure \ref{fig:Peristalsis}B). This suggests that a  command that inhibits peristalsis is sent when the larva is preparing for a large turn. Note, however, that this seems to be a graded response, the inhibitory command seems to vary in intensity and the peristalsis is not always completely interrupted (Figure \ref{fig:DynamicsExample}B, C).

Here we advance the tentative speculation that both the turning oscillator and the peristaltic wave might be continuously modulated by the same signal (Figure \ref{fig:Peristalsis}C).  If peristalsis inhibition is mediated by a separate signal, it should be possible to switch off oscillations and peristalsis inhibition independently. However, if the sensory inputs are combined into a same signal before being sent to both lateral oscillation and peristalsis modulation, then average speed, frequency of stopping events and average body bending amplitude should co-vary across stimuli conditions (with speed inversely correlated to the two others). Indeed, \cite{gomez2014multilevel} reported that larvae tend to accelerate when they move up-gradient - which is correlated with a reduced turn rate \citep{schleyer2015learning} - and decelerate when they move down-gradient - which is correlated with an increased turn rate \citep{schleyer2015learning}. This seems to suggest the existence of a continuous, quantitative, modulation of the peristaltic motion. 

However, the observed crawling speed is not purely continuous: the tail speed distribution is bimodal (Figure \ref{fig:Peristalsis}A).
 This does not necessarily imply that the descending signal is discontinuous, as the discontinuity could be due to the nature of the embodied peristaltic wave propagation dynamics. These could rely on positive feedback from stretch-rate receptors \citep{ross2015model} giving rise to non-linear dynamics that could be responsible for the abrupt disruption of the peristaltic wave's propagation.
 Therefore, while weak signals may modulate crawling speed, a strong enough signal may disrupt the peristaltic wave propagation, leading effectively to a stop (Figure \ref{fig:Peristalsis}D).
  This hypothesis could be tested as follows: any tonic stimuli having an impact on average crawling speed should have the opposite impact on the frequency of peristalsis inhibition events; and it should be possible to target optogenetically efferent connections towards abdominal segments that regulate speed, but also disrupt the peristalsis with stronger activation.

\subsection{Conclusion}
%doneKL\todoBW{cites in this paragraph (and above?) need to be changed to bibtex}
Larval taxis behaviour has been characterised as transitions between discrete states, or actions \citep{green1983organization, cobbwhatandhow1999, gomez2012active}  requiring ‘action-selection’ or ‘decision-making’ processes \citep{gomez2014multilevel}. Here we presented an alternative hypothesis where taxis results from a single simple sensory-motor process (Figure \ref{fig:Peristalsis}C). Sensory signals directly modulate the continuous lateral oscillations of the anterior body that we observed in larvae (Figure \ref{fig:DynamicsExample}).
By embedding the above hypothesis into an agent simulation model we showed that it captures a remarkable amount of chemotactic signatures observed in larvae. Under this light, explicit neural representations of actions such as curved run vs. turn or left vs. right are not required for the animal to perform taxis. Instead, these different actions emerge from the dynamic interactions between the sensory and motor processes, operating in a brain-body-environment loop.

An elegant picture emerges from this view. All sensory signals can combine by simply converging on the single process that lies at the core of taxis. Additional new features such as different sensory receptors or intermediate relays such as MB can be directly integrated to impact on behaviour in a meaningful way. Thus behaviour can adapt to new environmental conditions  without requiring new sensory-motor processing. It has been argued that over long time scales, natural selection favours not merely effective innovations, but systems that flexibly enable the incorporation of innovations \citep{vermeij1973adaptation}. The modularity of the system described here could provide such an evolutionary flexibility since it allows taxis behaviour to adapt by simply plugging-in or removing input modalities.


\section{Materials And Methods}
%TC:break _Methods_
\subsection{Real larvae path analysis.}
We analysed the tracks from 42 wild type larvae, using the same data recordings as \cite{gomez2011active}, as supplied by Matthieu Louis. Each 3rd instar foraging larval path was recorded for 5 min at 7fps after releasing each larval on a rectangular agarose slab opposite an odour source given by an ethyl butyrate droplet suspended from the lid. Tail, centroid and head positions were extracted from each frame of the video using custom tracking software at CRG (see ref). We used Matlab to analyse the tracks. Body bending was calculated as the angle formed between the tail-to-centroid axis and centroid-to-head axis. The variable ‘angular velocity of the anterior part of the body’ was obtained as the derivative across time of the centroid-to-head axis orientation. Specifics of the path analysis are presented where appropriate in the result sections. 

\subsection{Agent-based simulation in discrete time steps}
\label{sec:methodsDiscreteAgent}
The agent model is an abstract description of the mechanism we believe larvae use to trace the source of an odour. It runs in discrete time $n \in \{1 \cdots N\}$ describing the change in the position $x_n,y_n$ and orientation $\theta_n \in {-2 \kappa \pi,+2 \kappa \pi}$ of a point-sensor assumed to be on the end of the larva's head. At each time-step $n$ the orientation $\theta_n$ angle is updated under the influence of an intrinsic left-right turning pattern. This pattern represents the observed continuous oscillation of the larva's anterior body. The baseline amplitude of this lateral oscillation is set by the constant input $\Theta_b$. Further, where a tonic input is required this is represented by $T_b$. The baseline angle and the tonic input are summed with the scaled response in sampled stimulus between two time-steps $\nabla s$. The constant input $T_b$ can represent a tonic input to the sensory-motor system, or the baseline- constant firing rate of sensory neurons on top of which changes in stimuli are encoded via the characteristic transient responses of sensory neurons \citep{nagel2011biophysical}.
The algorithm of re-orientation can be summarized by the following recurrence equation:

\begin{align}
\theta_n &= \theta_{n-1} + H(\Theta_b + G (T_b + \nabla s_{n-1})){(-1)}^n,
\label{eqn:Discretemodel}
\end{align}

where  transient-to-turn modulation gain is $G$, $\nabla s_{n-1}  = s_{n-1} - s_{n-2}$ represents the change in the sampled stimulus between two time steps, $\Theta_b$ is the baseline oscillation angle, $T_b$ is the tonic input and $H(x)$ is a hardlimit function :

\begin{equation}
H(x) =
\begin{cases}
x \mbox{ if } 0 \leq x \geq \pi \\
\pi \mbox{ if } x > \pi  \\
0 \mbox{ if } x < 0 
\end{cases}
\end{equation}

The agent moves by a step $\alpha$ at each step $n$ in the direction $\theta_n$, thus its new position is set to :

\begin{align}
x_n &= x_{n-1}+ \alpha \cos \theta_{n} \\
y_n &= y_{n-1}+ \alpha  \sin \theta_{n}.
\end{align}

The sensory samples $s_{n-1}$ are then updated at the new head position as :

\begin{equation}
s_n = S(x_n,y_n).
\end{equation}
The function $S(x,y)$ could be a  fixed odour-gradient map, or a bivariate normal distribution (see eq. \eqref{eqn:bivariateNormal}) can be used to represent the distribution of odour concentration around an odour source. 
 The maps of odour gradients used in our simulations have been provided by Matthieu Louis' Lab, as recorded in \citep{gomez2014multilevel}. Stronger odour source concentrations were modelled by simply scaling the gradient map.
If the agents hits the boundary of the odour gradient map in our agent simulations, a new  orientation is randomly assigned so the agent keeps within the boundaries.

With a negative gain $G$, the increases in sensory experience during the last step will result in a reduction in the innate turning away oscillating response at the next step. Therefore attraction results as turns away from the gradient are reduced (Figure \ref{fig:MethodAgent}C, inhibitory signal). Reverting the sign of the gain will make the agent turn away from the direction where the stimulus increase was detected, with the extent of the subsequent turn limited to be up to 180 degrees due to the $H(x)$ function. The resulting paths tend to be directed away the odour source. 

Attraction towards an odour thus requires a negative  gain $G$, and can be seen as using an inhibitory connection (iPN).  Most odours are innately attractive to larvae, but some are aversive \citep{hallem2006coding}. In our model, an aversive odour has the opposite effect on turning modulation. That is, one simply needs to use a positive gain $G$, which can be seen as using an excitatory connection (ePN). When the concentration perceived is increasing, the subsequent innate turn angle $\Theta_b$ is increased, and vice versa, leading the agent away from the source (Figure \ref{fig:MethodAgent}C, excitatory signal).

In some conditions we added noise (see results). The additive noise is modelled simply as :

\begin{equation}
\theta_n = \theta_{n-1} + H(\Theta_b + G (T_b + \nabla s_{n-1})){(-1)}^n + Z_n,
\end{equation}

where $Z_n$ is drawn from normal distribution and then added to the agent current turning angle. 
 
\subsection{Agent-based simulation in continuous time}
\label{sec:methodsCoupledOscillator}
%Model Description 
We use the single-segment model of the lamprey \citep{lansner1997realistic} to represent the neural oscillator underlying the larva's anterior body's lateral oscillation. Activity measured using using calcium bioluminance reporters  showed an asymmetry in the VNC's neurons wave-like activity between the left and right thoracic segments \citep{berni2015genetic}. We model such activity by a pair of compartments each producing the respective premotor neural activity of the anterior  body's left-right bending muscles at the thoracic segment of the larval body. To simplify our model we consider the response of the premotor neurons only without an explicit model of the driven motor neurons. Each compartment contains a pool of excitatory neurons $E$ and a cross-inhibitory interneuron $C$, which projects to the opposite compartment. The $E$ unit of \ref{fig:LampreyModel}.A with its self-connection therefore stands for the activity of a pool of excitatory neurons that interconnect within the compartment and project to the $C$ inhibitory neuron, while both  $E$ and $C$ receive an inhibitory connection from the $C$ neuron of the opposite compartment. Further the $E$ neurons of both compartments receive input from the $A$ unit, which represents pooled sensory input, and a modulatory influence from the $S$ unit, whose effects will be described shortly.


Our model is based on the version of \cite{wilson1999spikes} of the lamprey simplified model \citep{lansner1997realistic}  according to which the neuronal responses are given at the spike-rate level given by the \cite{naka1966s} function:
\begin{equation}
\label{eq:nakarushton}
R(x,h) = \begin{cases} 
\frac{m x^n}{h^n + x^n} &\mbox{if } x \geq 0 \\
0 						&\mbox{if } x < 0
\end{cases},
\end{equation}
which maps the stimulus intensity $x$ of the net synaptic input to the expected spike rate response of a neuron. The parameter $h$ sets the half-response threshold while $n$ sets the steepness of the response. Since spike-rates can only take positive values and therefore the function is constrained to lie positive integers up to the maximum $m$, which here will be set to $m=100$ throughout.% we will denote this constraint as $[x]_+$. 
Each neuron also accounts for spike rate adaptation effect due to a slow after hyperpolarization potential current $I_{AHP}$, which operates by raising the half-response threshold $h(t)$ of Eq. \eqref{eq:nakarushton}. The equations for the left side of the coupled oscillators we examine are as follows:
\begin{align}
\tau \frac{dE_L}{dt} & = - E_L +  R( A + W_{ee} E_L - W_{cc}C_R, 64 + g(A)H_{EL})\\
\frac{H_{EL}}{dt} &= \frac{1}{\tau_H(A)}(-H_{EL}+E_L)\\
\frac{dC_L}{dt} &= -C_L + R(100, A + W_{ce}E_L - W_{cc}C_R, 64+g(A)H_{CL})\\
\frac{dH_{CL}}{dt} &= \frac{1}{\tau_H(A)}(-H_{CL}+E_L),
\end{align}
where $E_L, C_L$ represent the excitatory and cross inhibitory neuron of the left compartment in Figure \ref{fig:LampreyModel}.A, while the $H_{X}$ represents the dynamics of the $I_{\text{AHP}}$ of a neuron, $R(x,h)$ is the \cite{naka1966s} function of Eq. \eqref{eq:nakarushton}, and $W_x$ are the synaptic weights shown on Figure  \ref{fig:LampreyModel}.A. On the same Figure we see that the neuromodulatory unit $S$ connects to both compartments, its effects are exerted via modifying the time-constant and gain of the $I_{\text{AHP}}$:
\begin{align}
g(A) &= 6 + \left( 0.09A \right)^2\\
\tau_H(A) &= \frac{35}{(1 + 0.04 A^2)},
\end{align}
where an increase in the input from $A$ will result in an increase of the $I_{\text{AHP}}$ gain and a decrease in its time constant $\tau_H$.
 The neural model has the respective equations for the right compartment, containing  $E_R$ and $C_R$ for the right side oscillator:
\begin{align}
\tau \frac{dE_R}{dt} & = - E_L +  R( A + W_{ee} E_R - W_{cc}C_L, 64 + g(A)H_{ER})\\
\frac{H_{ER}}{dt} &= \frac{1}{\tau_H(A)}(-H_{ER}+E_R)\\
\frac{dC_R}{dt} &= -C_R + R( A + W_{ce}E_R - W_{cc}C_L, 64+g(A)H_{CR})\\
\frac{dH_{CR}}{dt} &= \frac{1}{\tau_H(A)}(-H_{CR}+E_R),
\end{align}

%Head Model
In order to address questions concerning the interaction of intrinsic rhythm generation with sensory stimuli intimately linked with the motion of the larva body in an odour environment we extended to a neuro-mechanical model through the addition of a simple biophysical model of a larva's head. We construct a model of the anterior segment's bending using an idealized linear spring-mass-damper system, see Figure \ref{fig:LampreyModel}.B. The system represents a pivoting head-mass on a joint with a tail segment under the influence of restoration forces due elastic and damping forces exerted by the surrounding cuticle and opposing muscle forces for left-right rotation. The muscles would normally be driven by motor neurons, but here we simplify by assuming that the motor neurons replicate the activity of the $E_L$ and $E_R$ pre-motor neurons and thus the later can be directly used.
We further make the simplified assumption that the larva continuously moves at speed of 1mm/sec in the direction indicated by the body bending angle $\theta$. This simplification is justified in terms of our finding that the peristaltic wave peaks are uncorrelated with the body bending and thus can be taken as slow motion of the posterior body segment following the direction indicated by the head. However, our model does not capture the straightening of the body bend due to this motion, or the friction forces exerted from the contact with the ground withholding the restoration. Given that the oscillation is driven by the premotor neuron activity and that the larva is assumed to continuously move at constant speed the details of how the body bending is restored have been simplified out in our model to be driven by restorative elastic forces of the body. 
 We take a non-dimensionalized approach writing the muscle model driving the head as second order system of idealized spring-mass-damper \cite[see][]{fung2013biomechanics}:
\begin{equation}
\label{eqn:headmodel}
\frac{d^2\theta(t)}{dt^2} = - 2 \zeta \theta'(t) - (\theta(t)) + (E_L(t) - E_R(t)),
\end{equation}
where $\zeta= \dfrac{\eta}{ 2\sqrt{k \gamma}}$ defines the damping ratio, with $\eta$ the damping force coefficient, $k$ the stiffness coefficient of a linear spring and $\gamma$ the muscle gain.
We assume a muscle on each side of the body working against each other and thus in this two dimensional model the net torque produced is taken to be the difference in spike rates of the premotor neurons $E_L(t) - E_R(t)$ driving each muscle. 
Evidently the system is not representative of the larval muscle activity, but it allows us to examine an embodied sensory-motor process during chemotaxis in continuous time avoiding the use of a detailed body that in essence would still only describe the motion of the olfactory sensor at the larva's head model which is needed for our demonstration.
 Further, writing the system in this form allows us to avoid having to consider specific values for the parameters and examine a generic system described by a level of damping, for which we have chosen an intermediate value $\zeta=1/2$.
The translation of head angle $\theta$ of equation \ref{eqn:headmodel} to a bearing $B$ is via a simple integration. Bearing is then converted to Cartesian coordinates to indicate the position of the head as a point:
\begin{align}
\frac{dB}{dt} &= \theta(t)/10 \\
\frac{dx}{dt} &= \sin{\dfrac{B(t)}{10}} \\
\frac{dy}{dt} &= \cos{\dfrac{B(t)}{10}}
\end{align}
   
Lastly, we define the $A$ neuron activity pattern to be a combination of a tonic output $b_T$, which is required to maintain the oscillation but also influences the oscillation frequency \cite{lansner1997realistic}, with sensory information superimposed representing the derivative of the odour concentration $S$ assumed to be conveyed by the olfactory sensory neurons: 
\begin{equation}
A(t) = b_T + G \frac{dS}{dt},
\end{equation}
where $G$ defines the gain defining how much the derivative of the sensory stimuli alters the firing  rate of input $A$, which perturb ates the motor patterns and in turn influences the sensed stimulus in a closed-loop such that the rythmic behaviour generates input for adaptive control \cite[see][]{willis1997centrally}.
The sensory stimuli is drawn from a virtual odour gradient that is simply taken to be a scaled bivariate normal distribution:
%\todoKL{Needs a fix here. Maybe not show it explicitly}
\begin{multline}
m(x,y) = \frac{1}{2 \pi  \sigma_x \sigma_y \sqrt{1-\rho^2}}\\
      \exp\left(
        -\frac{1}{2(1-\rho^2)}
        \left[
          \frac{(x-\mu_x)^2}{\sigma_x^2} + 
          \frac{(y-\mu_y)^2}{\sigma_y^2} -
          \frac{2\rho(x-\mu_x)(y-\mu_y)}{\sigma_x \sigma_y} \right]\right)
\label{eqn:bivariateNormal}
\end{multline}
with $\rho = \frac{\Cov(x,y)}{\sigma_1 \sigma_2}$ being the correlation of $x$ and $y$.
The sensory information as a function of time is then given by :
\begin{equation}
S(t) = C m(x(t),y(t)).
\label{eq:SensoryFunction}
\end{equation}
The model system was evaluated numerically using mathematics software from \cite{math}
using the parameter set and initial conditions listed on table \ref{tbl:OscparameterSet}.
 For our purposes the choice of parameters was broad and any arbitrarily set that has sufficiently strong contralateral inhibition $W_{cc}$ such that the left-right oscillators quickly lock in antiphase while the frequency of the oscillation falls approximately within the larval range of 0.5Hz was sufficient. The frequency of the head-oscillation was examined using a Fourier transform (see supplementary material).
% We find that the behaviour arises over a wide set of parameters, however this analysis is deferred as our current focus is demonstrating the feasibility of such a neural system for taxis. For our demonstration we used the parameter set on Table \ref{tbl:OscparameterSet}. 

Further, we examined the change of bearing in response to a step change in the input firing rate of $A$. For these results we removed the system of neural oscillators coupled to the head-model from the odour environment and examine the change of bearing in response to step increase of amplitude $A_m$ in the input arriving from neuron $A$ at various time points $t_s$:
\begin{equation}
A(t) = b_T + A_m U(t-t_s),
\end{equation}
where $U(t)$ is the unit step function with an onset time at $t_s$. The change of bearing was measured by integrating the head angle for long enough time for it to settle back to its cycle of zero-average change of bearing. Each curve of \ref{fig:LampreyModel}.F consist of $10^2$ points covering $t_s$ timing over a full cycle of oscillation (ie. from one peak of $E_L$ burst to the next), while each curve differers in the step amplitude $A_m$.


\newpage
\section{Figures}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig1_dynamics example.pdf}
\caption{{\bf Anterior oscillation and peristalsis inhibition dynamics in larvae.} 
Left hand side graphs show the angular speed of the anterior part of the body (blue), body bending (black), and peristaltic steps (grey dotted lines) based on tail speed (green) corresponding to the paths shown on the right hand side. Number labels link particular events. 
{\bf A.} Section with no peristalsis inhibition. The larva shows a continuous alternation between left and right but turning is biased in both intensity and duration towards positive angles, resulting in a left curve.
{\bf B.} Section with an intermediate (1) and two stronger (2 and 3) peristalsis inhibition events, which do not interrupt turning alternation.
\label{fig:DynamicsExample}
}
\hrule
\end{center}
\end{figure}



\begin{figure}
\ContinuedFloat
\caption{
{\bf C.} Section including a peristalsis inhibition event covering two successive turns (4 and 5). The green bars (1 and 2) indicate moments at which the body bending decreases (from left to right) even though the larva anterior body is still slightly swinging towards the left. This is due to the simultaneous forward peristalsis motion bringing the posterior part of the body towards the axis of the anterior part. Angular speed of the anterior body provides thus a better proxy than body bend to infer the control commands involved.
 {\bf B,C.} Red dotted lines indicate onset of peristalsis inhibition (conservatively late measure) which occurs before strong angular speed or body bending. {\bf D.} Fourier analysis of the angular velocity of the anterior body (blue) and tail speed (green) across all larvae and a single individual (inset). Tail speed (peristalsis) rhythm is fairly constant across larva at around 1.0Hz, with slight harmonics of the tail speed at 0.5Hz, which results from the tendency of some larvae to alternate continuously between a weaker and stronger peristalsis wave (see {\bf A} tail speed for an example). The angular velocity of the anterior body (blue) shows a slower rhythm than the peristalsis, with a higher variation across and within individuals. Note that the rhythms are not multiple of each other, suggesting that they are operating independently.
{\bf  E,F.} Anterior body angular velocity (E) and body bending (F) plotted against tail speed for a random selection of points across all larvae track (blue). Dashed red line shows their relative distribution.
%Kl:I think AW fixed this\todoBW{Not clear what 'relative distribution' means. Also tail speed ratio becomes meaningless with few data points at high velocity, could cut off the curve}
 Full Red line shows ratio of data that are higher than current x value. Black line shows the ratio of such data (higher than current x value) that are below the tail speed threshold (black dash line). Although there are no clear cut categories, anterior body angular velocity seems a better predictor of peristalsis inhibition than body bending.
}
\hrule
\end{figure}



\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig2_method_agent.pdf}
\caption{
{\bf Discrete agent simulation.} {\bf A.} The agent consists of an oriented head segment, and performs successive steps that systematically alternate between a left and right swing.
\todoKL{The position of the head point is not clearly shown.}
 {\bf B.} The extent of a swing (e.g. to the right) is modulated by the change of concentration perceived during the previous step (to the left), relative to a baseline swing angle. Negative gain inhibits the angle towards 0 degrees (no heading change) when concentration perceived increases; and excites it up to 180 degrees (full U-turn) when concentration perceived decreases. Inversely, positive gain increases the angle up to 180 degrees when concentration perceived increase; and inhibits it towards 0 degrees when concentration perceived decreased.
{\bf C.} Example of a section of path taken by the agent. The transparent larva provides indication of the size of the body relative to each step. Black dots indicate the locations of the head, where the odour concentration is sampled across successive steps. Red line indicates the direction from which the agent’s head is coming, and the underlying dark continuous line indicates the overall path taken by the agent’s head. Each step is of 1mm length. The blue lines indicate the isoclines of the odour concentration.
{\bf D.} Example of paths resulting from negative and positive gain, showing respectively attraction towards and repulsion away from the stimulus source.
\label{fig:MethodAgent}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig3_orbital.pdf}
\caption{{\bf Typical path signatures for larvae and simulation.} {\bf A,B.} Example of paths. {\bf C,D.} Distributions of bearings to odour.
 Both larvae and simulated agent tends to spend most time with the odour located on their sides (-90 and 90 degrees), orbiting the source. In both larvae and simulation, orbital behaviour is emphasized during peristalsis forward motion (i.e. turn $<$ 30 degrees for the model) ({\bf C}. blue curve), and when the larvae/agent is more than 1cm away from the odour ({\bf D}. green curve). Crossing-over trajectories, by contrast, are constituted of regular large turns that happen mostly while the larvae/agent is heading away from the odour ({\bf C.} red curve), and is rather apparent when the larvae/agent is close to the odour ({\bf D.} blue curve).
\label{fig:PathSignatures}}
\hrule
\end{center}
\end{figure}













\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig4_Paths_across_gain.pdf}
\caption{{\bf OSN input and signal-to-turn modulation gain.}
{\bf A.} Time occupancy spatial maps for genotypes with re-engineered peripheral olfactory circuits tested in the near-source paradigm (30 mM odour source): wild type (N=42 flies), Or42a ectopically expressed in the 21 intact ORNs (all neuron pairs active, N=38), Or42a single-functional ORN (one pair of neuron active, N=37), and Orco null (anosmic flies, N=55) reproduced from \cite{gomez2011active}.
{\bf B}) The simulated agent given different transient-to-turn modulation gains can capture the patterns observed in larvae; suggesting that activity of the OSN simply sum up so that higher activity as a group leads to a stronger turning modulation signal.
%KL:Done \todoBW{Have we explained anywhere how agent behaves at boundaries (takes random direction)? Should add to end of methods section 4.2?}
\label{fig:OSN}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig5_conc_learn.pdf}
\caption{{\bf Effect of odour concentration and appetitive conditioning on bearing to odour distribution and rate of turns.} {\bf A,C.} Real larva data are drawn from \citep{schleyer2015learning}. {\bf B,D}. In our simulation (shows mean $\pm$ standard deviation) turning events were categorised as large turns if $>30$ degrees and not followed by another large turn. Changes in concentration were obtained by multiplying the gradient by a factor 0, 1 or 2. Learning was modelled as a change in transient-to-turn modulation gain (0, -2 or -5). The same qualitative changes in turn angle and turn rate relative to odour bearing are observed.
\label{fig:Concentration}}
\hrule
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig6_Pref_indexes.pdf}
\caption{{\bf Preference index and robustness to noise. }
{\bf A,C}. Preference index as calculated by the ratio of 30 simulated larvae ending up on the odour side/other side after 3 minutes. {\bf B,D.} Final distance to odour 
{\bf A,B.} Given biologically relevant bounds, the preference index seems to vary linearly with transient-to-turn modulation gain. For comparison, real larvae data (grey boxes) are drawn from appetitive learning in \citep{schleyer2011behavior}.
{\bf C,D.} Impact of noise on preference index (C) and distance to odour (D). Noise values correspond to the standard deviation of the normal distribution from which the noisy angle is drawn at each step. The linear effect of gain change remains evident at high noise levels.
\todoBW{Could consider removing B,D; they don't add much information}
\label{fig:PreferenceIndex}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig9_gustatory_index.pdf}
\caption{{\bf Effect of presence of fructose and tonic signal.}
{\bf A.} Increased turn rates in larva in the presence of fructose (top; drawn from \citep{schleyer2015learning}) can be replicated by the presence of a tonic signal in our simulation (bottom; see Figure \ref{fig:Concentration} for specifics). 
{\bf B.} Gustatory index as calculated by the ratio of 30 simulated larvae ending up on the fructose side/other side after 3 minutes is shown across signal-to-turn modulation gain for phasic and tonic signals. Only negative gain response to a phasic signal seems to explain the positive gustatory index shown in real larvae in presence of fructose \citep{schleyer2011behavior}.
{\bf C,D.} Example of section of paths taken by the agent illustrating response to phasic (left) and tonic (right) signal in the presence of fructose (green area).
\todoBW{I'm not sure what is explained in Figure \ref{fig:Concentration} that is usefully specific here?}
\label{fig:Tonic}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig7sensory_exp.pdf}
\caption{{\bf Sensory history and monotonic decrease in concentration.} {\bf A,B.} Example of simulated path and the associated sensory history given the background and transient odour concentration.
{\bf  C.} Average ($\pm 95\%$CI) and individual’s example of the sensory history experienced before and after large turn events ($>90$ degrees) in our simulation. For all large turns (black), or only the large turns that result in experiencing a positive (red) or a negative transient (blue). A slow monotonic decrease in concentration precedes large turns even though turns are the consequence of the transient experienced during the previous step only.
\label{fig:SensoryHistory}}
\hrule
\end{center}
\end{figure}

%[!ht]
\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig8_bias_correct_side.pdf}
\caption{{\bf First turn bias towards the correct side.} First turns were categorised as large turns (turn $>30$ degrees) that were not preceded by a large turn at the previous timestep.
{\bf A.} Probability of turning to the correct side (i.e. towards the odour; 1st column ‘C’) and wrong side (second column ‘W’). Higher signals (i.e. increased concentration or stronger transient-to-turn modulation gain) increase the bias.
{\bf B.} Turning direction (mean $\pm$ standard deviation) given the bearing to odour. Green and red zones indicate turn towards (i.e. correct side) or away (i.e. wrong side) from the odour respectively. Noise $Z = 10$. Time $t=800$. $N=1000$ larvae ($n > 25000$ for each group)
\label{fig:FirstTurn}}
\hrule
\end{center}
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig10_continuous_model.pdf}
\caption{{\bf Neural model in continuous time.} {\bf A.} Central pattern generator based on lamprey model. Arrows indicate excitatory connections, a bar denotes an inhibitory connection and circle denotes a neuromodulatory connection. Connections terminating on a bounding box must be taken to mean the connection is to all bounded neuron units. The $A$ unit represents the afferent sensory stimuli projecting to oscillating compartments on both sides. The $S$ unit represents a neuromodulatory neuron which  modulates the half-response threshold of the $E$ and $C$ neurons \cite[see]{wilson1999spikes} to effectively imitate the effects of a slow adapting current. We denote the left and right $E$ as $E_L$ and $E_R$ respectively.
{\bf B.} Larva head turning biomechanic model. Anterior segment bending uses a torsional spring to represent the restoring viscoelastic forces of the larva.
{\bf C.} Frequency of head oscillations that are comparable to data.
{\bf D.} Example chemotax trajectories in a virtual odour gradient with different gain.
{\bf E.} Model dynamics during chemotaxis trajectory, showing $E_L$ and  $E_R$, $\theta'$ and the $A$ input as influenced by the moving larva in the environment. Under high-gain the turns appear sharper.
{\bf F.} Effects of unit-step perturbations on bearing angle of an oscillator model coupled to a simple larva head model across oscillator phase. Panels below show the simultaneous state of the head angular velocity, an example input from $A$ and the respective state of neural bursts from $E_L$ and $E_R$ (here shown unperturbed by the input $A$).
%KLDone\todoBW{plot refers to L and R oscillators rather than  $E_L$ and  $E_R$}
\label{fig:LampreyModel}}
\hrule
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=110mm]{figures/Fig11_discussion.pdf}
\caption{{\bf Oscillations and peristalsis modulations.} {\bf A.} Real larvae tail velocities show a bimodal distribution, with the first peak corresponding to peristalsis inhibition events. Inset illustrates the extraction of maxima peaks (red curve) of tail velocities.
{\bf B.} Average ($\pm 95\%$CI) of the anterior body angular velocity (blue), body bending (black) and tail velocities (green) displayed before and after peristalsis inhibition events (aligned at t=0). Red line highlights that average tail speed velocity (green) starts dropping before the occurrence of large increase of body bending (black) or anterior body angular velocity (blue). This suggests that tail speed is not a mere physical consequence of large turning event.
{\bf C.} Conceptual scheme illustrating our overall view: all modalities, innate and learnt, tonic (full line) or phasic (dashed line) signals are integrated at their zone of convergence. The summed signal is sent to both 1-the neural oscillator mediating turning of the anterior body and localised in the thoracic segment (blue), and 2- motor neurons along the abdominal segments to mediate peristalsis inhibition (green). MB: Mushroom body, where signal weightings can be modulated given the co-activation of a reinforcer neuron (R).
\label{fig:Peristalsis}}
\hrule
\end{center}
\end{figure}



\begin{figure}
\ContinuedFloat
\caption{
{\bf D.} Qualitative prediction of the anterior body angular velocity (blue) and tail speed velocities (green) as a result of the summed sensory signal perceived. Growing signal strength increases anterior body turning and inhibits crawling speed simultaneously. If the signal is sufficiently strong peristalsis disruption happens, leading to an abrupt drop of tail speed velocities. The relaxing of the synchronous left-right body contraction during peristalsis enhances the reaction to the thoracic left-right asynchronous contraction resulting in sharp increase in body turning. Peristalsis spontaneously resumes when the sensory command lowers below peristalsis disruption threshold. Thus one continuous control signal could explain the emergence of straight runs, weathervaning and the stop and head-casts actions observed in larvae.
}
\end{figure}



\include{NeuralOscillatorSuppContent}

%TC:ignore 
\clearpage
\bibliography{NeuralOscillatorPaper}
%TC:endignore 


%\include{NeuralOscillatorPaperSupp}
\section*{wordcount}
\newcommand\wordcount{ \verbinput{ /tmp/wordcount.tex}}
\wordcount

\end{document}

